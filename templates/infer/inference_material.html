<!-- Bootstrap CSS -->
<script src="/static/js/jquery-2.1.4.min.js"></script>
<link href="/static/css/bootstrap.min.css" rel="stylesheet">
<script src="/static/js/layer/layer.js"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="/static/css/all.min.css">
<script src="/static/js/bootstrap.bundle.min.js"></script>
{% block extra_css %}
<style>
    /* 通用表格样式，保持项目一致性 */
    .table-container {
        background-color: #fff;
        border-radius: 0.375rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .action-buttons {
        margin-bottom: 1.5rem;
    }

    .action-buttons .btn {
        margin-right: 0.5rem;
    }

    /* 状态标签样式 */
    .badge-not-start {
        background-color: #6c757d;
    }

    .badge-inferring {
        background-color: #fd7e14;
    }

    .badge-completed {
        background-color: #28a745;
    }


    /* 任务列表样式优化 */
    .material-table th {
        white-space: nowrap;
    }

    /* 分页样式复用，保持与项目一致 */
    .pagination {
        display: flex;
        justify-content: center;
        padding: 10px 0;
        margin: 0;
    }

    .pagination .page-item {
        margin: 0 2px;
    }

    .pagination .page-link {
        color: #007bff;
        padding: 0.5rem 0.75rem;
        text-decoration: none;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }

    .pagination .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }

    .pagination .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        background-color: #fff;
        border-color: #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div>
    <!-- 图片素材表格容器 -->
    <div class="table-container">
        <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">刷新</button>
        <table class="table table-striped table-hover material-table">
            <thead>
                <tr>
                    <th scope="col" width="8%">序号</th>
                    <th scope="col" width="25%">文件名称</th>
                    <th scope="col" width="20%">数量</th>
                    <th scope="col" width="15%">状态</th>
                    <th scope="col" width="22%">操作</th>
                </tr>
            </thead>
            <tbody id="imageMaterialTable">
                {% for m in materials %}
                <tr>
                    <td>{{ loop.index + (pagination.page - 1) * pagination.per_page }}</td>
                    <td>{{ m.filename }}</td>
                    <td>
                        {{ m.total_count }}
                    </td>
                    <td><span class="badge {{ m.status_class }}">{{ m.status_text }}</span></td>
                    <td>
                        {% if m.status == 0 %}
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="startMaterialInference('{{ project.id }}', '{{ m.id }}')">
                            推理
                        </button>
                        {% endif %}
                        {% if m.status == 1 and m.material_type == 3%}
                        <button class="btn btn-sm btn-primary"
                            onclick="openResultModal('{{ project.id }}', '{{ m.id }}')">
                            查看
                        </button>
                        <button class="btn btn-sm btn-primary"
                            onclick="stopInference('{{ project.id }}', '{{ m.id }}')">
                            停止推理
                        </button>
                        {% endif %}
                        {% if m.status == 2 %}
                        <button class="btn btn-sm btn-primary"
                            onclick="openResultModal('{{ project.id }}', '{{ m.id }}')">
                            查看
                        </button>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="startMaterialInference('{{ project.id }}', '{{ m.id }}')">
                            重新推理
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 分页控件 -->
    {% if pagination.pages >= 1 %}
    <nav aria-label="图片分页">
        <ul class="pagination">
            <!-- 上一页 -->
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('main.api_inference_material_page', project_id=project.id, page=pagination.prev_num, per_page=pagination.per_page) }}"
                    aria-label="上一页">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">&laquo;</span>
            </li>
            {% endif %}

            <!-- 页码 -->
            {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
            {% if page_num != pagination.page %}
            <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('main.api_inference_material_page', project_id=project.id, page=page_num, per_page=pagination.per_page) }}">{{
                    page_num }}</a>
            </li>
            {% else %}
            <li class="page-item active">
                <span class="page-link">{{ page_num }}</span>
            </li>
            {% endif %}
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">…</span>
            </li>
            {% endif %}
            {% endfor %}

            <!-- 下一页 -->
            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('main.api_inference_material_page', project_id=project.id, page=pagination.next_num, per_page=pagination.per_page) }}"
                    aria-label="下一页">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">&raquo;</span>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% else %}
    <div id="inferenceResult" class="text-center">
        <div class="py-5">
            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">等待推理结果</h4>
            <p class="text-muted">选择模型和上传推理素材，然后点击开始推理</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}

<script>

    function stopInference(projectId, materialId) {
        // 向父页面发送消息：包含项目ID和素材ID
        window.parent.postMessage({
            type: 'stopInference',
            projectId: projectId,
            materialId: materialId
        }, window.location.origin);
    }
    function openResultModal(projectId, materialId) {
        // 向父页面发送消息：包含项目ID和素材ID
        window.parent.postMessage({
            type: 'openResultModal',
            projectId: projectId,
            materialId: materialId
        }, window.location.origin);
    }
    function startMaterialInference(projectId, materialId) {
        window.parent.postMessage({
            type: 'startInference',
            materialId: materialId
        }, window.location.origin);
    }
    document.addEventListener('DOMContentLoaded', function () {
        const perPageSelect = document.getElementById('perPageSelect');
    });


    window.addEventListener('message', function (event) {
        console.log('接收到消息：', event.origin, event.data)
        // if (!window.ALLOWED_ORIGINS.includes(event.origin)) return;
        if (event.data.type === 'refrensh') {
            window.location.reload()
        }
    });
</script>

{% endblock %}