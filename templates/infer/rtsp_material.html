<!-- Bootstrap CSS -->
<script src="/static/js/jquery-2.1.4.min.js"></script>
<link href="/static/css/bootstrap.min.css" rel="stylesheet">
<script src="/static/js/layer/layer.js"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="/static/css/all.min.css">
<script src="/static/js/bootstrap.bundle.min.js"></script>
{% block extra_css %}
<style>
    /* 通用表格样式，保持项目一致性 */
    .table-container {
        background-color: #fff;
        border-radius: 0.375rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .action-buttons {
        margin-bottom: 1.5rem;
    }

    .action-buttons .btn {
        margin-right: 0.5rem;
    }

    /* 状态标签样式 */
    .badge-not-start {
        background-color: #6c757d;
    }

    .badge-inferring {
        background-color: #fd7e14;
    }

    .badge-completed {
        background-color: #28a745;
    }

    /* RTSP专属提示样式 */
    .rtsp-long-tip {
        font-size: 0.875rem;
        color: #fd7e14;
        margin-bottom: 1rem;
        text-align: right;
    }

    /* 分页样式复用，保持与项目一致 */
    .pagination {
        display: flex;
        justify-content: center;
        padding: 10px 0;
        margin: 0;
    }

    .pagination .page-item {
        margin: 0 2px;
    }

    .pagination .page-link {
        color: #007bff;
        padding: 0.5rem 0.75rem;
        text-decoration: none;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }

    .pagination .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }

    .pagination .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        background-color: #fff;
        border-color: #dee2e6;
    }

    /* 表格地址换行处理 */
    .table td.rtsp-address {
        word-break: break-all;
    }

    /* 任务列表样式优化 */
    .material-table th {
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <!-- 页面标题与操作按钮 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-stream text-warning"></i> RTSP推理素材管理</h3>
        <div class="action-buttons">
            <span class="me-2">每页显示:</span>
            <select id="perPageSelect" class="form-select form-select-sm d-inline-block w-auto">
                <option value="10" {% if pagination.per_page==10 %}selected{% endif %}>10</option>
                <option value="25" {% if pagination.per_page==25 %}selected{% endif %}>25</option>
                <option value="50" {% if pagination.per_page==50 %}selected{% endif %}>50</option>
                <option value="100" {% if pagination.per_page==100 %}selected{% endif %}>100</option>
            </select>
            <button type="button" class="btn btn-primary" onclick="addRtspBtn()" 
                >
                <i class="fas fa-plus"></i> 添加
            </button>
        </div>
    </div>

    <!-- RTSP长期推理提示 -->
    <div class="rtsp-long-tip">
        <i class="fas fa-lightbulb"></i> 结束时间为空则表示长期推理
    </div>

    <!-- RTSP素材表格容器 -->
    <div class="table-container">
        <table class="table table-striped table-hover material-table">
            <thead>
                <tr>
                    <th scope="col" width="8%">序号</th>
                    <th scope="col" width="10%">流名称</th>
                    <th scope="col" width="20%">RTSP地址</th>
                    <th scope="col" width="18%">开始时间</th>
                    <th scope="col" width="18%">结束时间</th>
                    <th scope="col" width="12%">状态</th>
                    <th scope="col" width="14%">操作</th>
                </tr>
            </thead>
            <tbody id="rtspMaterialTable">
                {% for m in materials %}
                <tr>
                    <td>{{ loop.index + (pagination.page - 1) * pagination.per_page }}</td>
                    <td>{{ m.filename }}</td>
                    <td>{{ m.path }}</td>
                    <td>{{ m.start_time.strftime("%Y-%m-%d %H:%M:%S") if m.start_time else "" }}</td>
                    <td>{{ m.end_time.strftime("%Y-%m-%d %H:%M:%S") if m.end_time else "" }}</td>
                    <td><span class="badge {{ m.status_class }}">{{ m.status_text }}</span></td>
                    <td>
                        {% if m.status == 0 %}
                        <button class="btn btn-sm btn-primary me-2" onclick="openConfigDrawer({
                            'id':'{{ m.id }}',
                            'filename':'{{m.filename}}',
                            'path':'{{m.path}}'
                        })">配置</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMaterial('{{ m.id }}')">删除</button>
                        {% elif m.status == 1 %}
                        -
                        {% elif m.status == 2 %}
                        <button class="btn btn-sm btn-outline-primary">查看</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 分页控件 -->
    {% if pagination.pages >= 1 %}
    <nav aria-label="图片分页">
        <ul class="pagination">
            <!-- 上一页 -->
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('main.infer_image_material', project_id=project.id, page=pagination.prev_num, per_page=pagination.per_page) }}"
                    aria-label="上一页">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">&laquo;</span>
            </li>
            {% endif %}

            <!-- 页码 -->
            {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
            {% if page_num != pagination.page %}
            <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('main.infer_image_material', project_id=project.id, page=page_num, per_page=pagination.per_page) }}">{{
                    page_num }}</a>
            </li>
            {% else %}
            <li class="page-item active">
                <span class="page-link">{{ page_num }}</span>
            </li>
            {% endif %}
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">…</span>
            </li>
            {% endif %}
            {% endfor %}

            <!-- 下一页 -->
            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('main.infer_image_material', project_id=project.id, page=pagination.next_num, per_page=pagination.per_page) }}"
                    aria-label="下一页">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">&raquo;</span>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-file-video fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">暂无RSTP流</h4>
        <p class="text-muted">请添加流</p>
    </div>
    {% endif %}
</div>

<!-- 添加RTSP地址弹窗 -->
<div  id="addRtspModal" style="display: none;" >
    <div class="modal-dialog modal-lg"  style="padding:20px;">
        <div class="modal-content">
            <div class="modal-body">
                <form id="rtspAddForm">
                    <div class="mb-3">
                        <label for="rtspName" class="form-label">流名称（便于识别）</label>
                        <input type="text" class="form-control" id="rtspName" name="rtspName"
                            placeholder="如：园区主路监控、大门入口监控">
                    </div>
                    <div class="mb-3">
                        <label for="rtspUrl" class="form-label">RTSP地址</label>
                        <input type="text" class="form-control" id="rtspUrl" name="rtspUrl"
                            placeholder="格式：rtsp://用户名:密码@IP地址:端口/流路径" value="rtsp://admin:123456@">
                        <div class="form-text">示例：rtsp://admin:123456@192.168.1.100:554/stream1</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">推理时间配置</label>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="startTime" class="form-label">开始时间</label>
                                <input type="datetime-local" class="form-control" id="startTime" name="startTime">
                            </div>
                            <div class="col-md-6">
                                <label for="endTime" class="form-label">结束时间（留空=长期推理）</label>
                                <input type="datetime-local" class="form-control" id="endTime" name="endTime">
                                <div class="rtsp-long-tip">留空表示长期持续推理，直到手动停止</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="checkRtspBtn()" >
                            <i class="fas fa-check"></i> 校验地址有效性
                        </button>
                <button type="button" class="btn btn-secondary" style="margin-left:5px;" onclick="layer.closeAll()">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitUpload()" style="margin-left:5px;">确认添加</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(function () {
        const perPageSelect = document.getElementById('perPageSelect');
        // 监听每页显示数量变化
        perPageSelect.addEventListener('change', function () {
            const perPage = this.value;
            const url = new URL(window.location);
            url.searchParams.set('per_page', perPage);
            url.searchParams.set('page', 1); // 重置到第一页
            window.location.href = url.toString();
        });
        
    });
    function addRtspBtn(){
        layer.open({
            title:"添加RTSP网络流地址",
            type: 1, 
            area: ['600px', '500px'],
            content: $("#addRtspModal") //这里content是一个普通的String
        });
    }

    function checkRtspBtn() {
            const rtspUrl = document.getElementById('rtspUrl').value.trim();
            if (!rtspUrl) {
                document.getElementById('rtspCheckResult').innerHTML = '<span class="text-danger">请输入有效的RTSP地址</span>';
                return;
            }

            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 校验中...';
            this.disabled = true;
            document.getElementById('rtspCheckResult').innerHTML = '';

            // 对接后端校验接口，模拟校验过程
            setTimeout(() => {
                if (rtspUrl.startsWith('rtsp://')) {
                    document.getElementById('rtspCheckResult').innerHTML = '<span class="text-success">✓ 地址格式合法，可正常连接</span>';
                } else {
                    document.getElementById('rtspCheckResult').innerHTML = '<span class="text-danger">× 地址格式错误，需以rtsp://开头</span>';
                }
                this.innerHTML = '<i class="fas fa-check"></i> 校验地址有效性';
                this.disabled = false;
            }, 2000);
        }


    // 提交添加RTSP地址
        function submitUpload() {
            const rtspName = document.getElementById('rtspName').value.trim();
            const rtspUrl = document.getElementById('rtspUrl').value.trim();

            if (!rtspName || !rtspUrl) {
                layer.msg('请填写流名称和RTSP地址');
                return;
            }

            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 添加中...';
            this.disabled = true;

            const form = document.getElementById('rtspAddForm');
            const formData = new FormData(form);


            fetch('{{ url_for("main.upload_rtsp_material", project_id=project.id) }}', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(response => {
                    if (response.success) {
                        layer.msg('上传成功！')
                        setTimeout(() => {
                            location.reload()
                        }, 2000)
                    } else {
                        layer.msg(response.message)
                    }
                })
                .catch(error => {
                    console.log('上传图片失败：', error)
                    layer.msg('上传失败！')
                })
                .finally(() => {
                    this.innerHTML = '<i class="fas fa-plus"></i> 确认添加';
                    layer.closeAll();
                    this.disabled = false;
                    form.reset();
                })
        }

    
    function openResultModal(projectId, materialId) {
        layer.open({
            title:"推理结果详情",
            type: 2, 
            area: ['80%', '90%'],
            content: `/api/inference/${projectId}/result/${materialId}` //这里content是一个普通的String
        });
    }

    
</script>
{% endblock %}