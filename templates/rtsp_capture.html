{% block extra_css %}
<style>
    .capture-card {
        transition: transform 0.2s;
    }

    .capture-card:hover {
        transform: scale(1.02);
    }

    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }

    .status-running {
        background-color: #28a745;
    }

    .status-stopped {
        background-color: #dc3545;
    }

    .status-pending {
        background-color: #ffc107;
    }

    .video-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 15px;
    }

    #videoPlayer {
        width: 100%;
        height: 400px;
        background: #000;
    }
</style>
{% endblock %}

{% block content %}

<div style="overflow: hidden;">
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>RTSP截图</span>
                        <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#rtspHelp" aria-expanded="false" aria-controls="rtspHelp">
                            <i class="fas fa-question-circle"></i> 帮助
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="collapse" id="rtspHelp">
                        <div class="alert alert-info">
                            <h6>RTSP截图说明：</h6>
                            <ul>
                                <li>输入RTSP地址，设置截图间隔和总数量开始截图</li>
                                <li>截图会自动保存到当前项目中</li>
                                <li>可以通过停止按钮中断截图过程</li>
                            </ul>
                        </div>
                    </div>

                    <form id="rtspForm">
                        <div class="mb-3">
                            <label for="rtspUrl" class="form-label">RTSP地址</label>
                            <input type="text" class="form-control" style="width: 60%;display: inline-block;"
                                id="rtspUrl" placeholder="rtsp://username:password@ip:port/path" required>
                            <button type="submit" class="btn btn-primary" id="previewRtspBtn">
                                <i class="fas fa-play"></i> 预览
                            </button>
                            <button type="button" class="btn btn-secondary" id="stopPreviewRtspBtn"
                                style="display: none;">
                                <i class="fas fa-video"></i> 停止预览
                        </div>
                        <!-- 视频播放器区域 -->
                        <div id="videoPlayerContainer" style="display: none;">
                            <div class="video-container">
                                <video id="videoPlayer" controls>
                                    <source id="videoSource" src="">
                                    您的浏览器不支持视频播放
                                </video>
                            </div>

                            <!-- 手动截图控制 -->
                            <div class="capture-controls">
                                <button class="btn btn-primary manual-capture-btn" id="manualCaptureBtn">
                                    <i class="fas fa-camera"></i> 手动截图
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="interval" class="form-label">截图间隔（秒）</label>
                                    <input type="number" class="form-control" id="interval" min="1" max="3600" value="5"
                                        required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="maxCount" class="form-label">总截图数量</label>
                                    <input type="number" class="form-control" id="maxCount" min="1" max="10000"
                                        value="10" required>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary" id="startRtspBtn">
                            <i class="fas fa-play"></i> 开始截图（自动）
                        </button>
                        <button type="button" class="btn btn-danger" id="stopRtspBtn" disabled>
                            <i class="fas fa-stop"></i> 停止截图
                        </button>
                    </form>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <span>ONVIF摄像头截图</span>
                    <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse"
                        data-bs-target="#onvifHelp" aria-expanded="false" aria-controls="onvifHelp">
                        <i class="fas fa-question-circle"></i> 帮助
                    </button>
                </div>
                <div class="card-body">
                    <div class="collapse" id="onvifHelp">
                        <div class="alert alert-info">
                            <h6>ONVIF摄像头截图说明：</h6>
                            <ul>
                                <li>点击"查找摄像头"按钮发现局域网内的ONVIF设备</li>
                                <li>选择设备并输入用户名密码</li>
                                <li>选择摄像头通道，设置截图间隔和总数量开始截图</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mb-3">
                        <button class="btn btn-info" id="discoverBtn">
                            <i class="fas fa-search"></i> 查找摄像头
                        </button>
                    </div>

                    <div id="onvifDevices" class="mb-3" style="display: none;">
                        <h6>发现的设备：</h6>
                        <div id="devicesList"></div>
                    </div>

                    <div id="onvifFormContainer" style="display: none;">
                        <form id="onvifLoginForm">
                            <input type="hidden" id="deviceIp">
                            <input type="hidden" id="devicePort">

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="onvifUsername" class="form-label">用户名</label>
                                        <input type="text" class="form-control" id="onvifUsername" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="onvifPassword" class="form-label">密码</label>
                                        <input type="password" class="form-control" id="onvifPassword" required>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-secondary">
                                <i class="fas fa-sign-in-alt"></i> 登录设备
                            </button>
                        </form>
                    </div>

                    <div id="profilesContainer" style="display: none;">
                        <h6>摄像头通道：</h6>
                        <div id="profilesList" class="mb-3"></div>

                        <form id="onvifCaptureForm">
                            <input type="hidden" id="selectedProfile">

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="onvifInterval" class="form-label">截图间隔（秒）</label>
                                        <input type="number" class="form-control" id="onvifInterval" min="1" max="3600"
                                            value="5" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="onvifMaxCount" class="form-label">总截图数量</label>
                                        <input type="number" class="form-control" id="onvifMaxCount" min="1" max="10000"
                                            value="10" required>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary" id="startOnvifBtn">
                                <i class="fas fa-play"></i> 开始截图
                            </button>
                            <button type="button" class="btn btn-danger" id="stopOnvifBtn" disabled>
                                <i class="fas fa-stop"></i> 停止截图
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    截图状态
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>RTSP截图状态</h6>
                        <div id="rtspStatus">
                            <span class="status-indicator status-stopped"></span>
                            <span>未运行</span>
                        </div>
                        <div class="mt-2">
                            <small>已截图: <span id="rtspCapturedCount">0</span>/<span id="rtspMaxCount">0</span></small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>RTSP预览状态</h6>
                        <div id="rtspPreviewStatus">
                            <span class="status-indicator status-stopped"></span>
                            <span>未运行</span>
                        </div>
                        <!-- <div class="mt-2">
                            <small>已截图: <span id="rtspPreviewCapturedCount">0</span></small>
                        </div> -->
                    </div>

                    <div class="mb-3">
                        <h6>ONVIF截图状态</h6>
                        <div id="onvifStatus">
                            <span class="status-indicator status-stopped"></span>
                            <span>未运行</span>
                        </div>
                        <div class="mt-2">
                            <small>已截图: <span id="onvifCapturedCount">0</span>/<span id="onvifMaxCount">0</span></small>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button class="btn btn-sm btn-outline-primary" id="refreshStatusBtn">
                            <i class="fas fa-sync"></i> 刷新状态
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

    $(function () {
        const projectId = '{{ project.id }}'
        // 全局声明hls实例，方便销毁重复实例
        let hlsInstance = null;

        // RTSP截图功能
        const rtspForm = document.getElementById('rtspForm');
        const startRtspBtn = document.getElementById('startRtspBtn');
        const stopRtspBtn = document.getElementById('stopRtspBtn');
        const previewRtspBtn = document.getElementById('previewRtspBtn');
        const videoPlayerContainer = document.getElementById('videoPlayerContainer');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoSource = document.getElementById('videoSource');
        const manualCaptureBtn = document.getElementById('manualCaptureBtn');
        const stopPreviewRtspBtn = document.getElementById('stopPreviewRtspBtn');

        // ONVIF功能
        const discoverBtn = document.getElementById('discoverBtn');
        const onvifDevices = document.getElementById('onvifDevices');
        const devicesList = document.getElementById('devicesList');
        const onvifFormContainer = document.getElementById('onvifFormContainer');
        const onvifLoginForm = document.getElementById('onvifLoginForm');
        const profilesContainer = document.getElementById('profilesContainer');
        const profilesList = document.getElementById('profilesList');
        const onvifCaptureForm = document.getElementById('onvifCaptureForm');
        const startOnvifBtn = document.getElementById('startOnvifBtn');
        const stopOnvifBtn = document.getElementById('stopOnvifBtn');

        // 状态显示元素
        const rtspStatus = document.getElementById('rtspStatus');
        const rtspCapturedCount = document.getElementById('rtspCapturedCount');
        const rtspMaxCount = document.getElementById('rtspMaxCount');
        const onvifStatus = document.getElementById('onvifStatus');
        const onvifCapturedCount = document.getElementById('onvifCapturedCount');
        const onvifMaxCount = document.getElementById('onvifMaxCount');
        const refreshStatusBtn = document.getElementById('refreshStatusBtn');
        const rtspPreviewStatus = document.getElementById('rtspPreviewStatus');

        // RTSP截图表单提交
        startRtspBtn.addEventListener('click', function (e) {
            e.preventDefault();

            const rtspUrl = document.getElementById('rtspUrl').value;
            const interval = parseInt(document.getElementById('interval').value);
            const maxCount = parseInt(document.getElementById('maxCount').value);

            startRtspBtn.disabled = true;
            fetch(`/api/project/${projectId}/rtsp/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    rtsp_url: rtspUrl,
                    interval: interval,
                    max_count: maxCount
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        stopRtspBtn.disabled = false;
                        updateRtspStatus();
                        startRtspBtn.innerHTML = '<i class="fas fa-play"></i> 正在运行';
                    } else {
                        layer.msg('启动失败: ' + data.message);
                        startRtspBtn.disabled = false;
                        startRtspBtn.innerHTML = '<i class="fas fa-play"></i> 开始截图（自动）';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('启动截图时发生错误');
                    startRtspBtn.disabled = false;
                    startRtspBtn.innerHTML = '<i class="fas fa-play"></i> 开始截图（自动）';
                });
        });
        stopPreviewRtspBtn.addEventListener('click', function () {
            // 停止预览视频
            if (hlsInstance) {
                hlsInstance.destroy();
                hlsInstance = null;
            }
            videoPlayer.pause();
            videoPlayerContainer.style.display = 'none';
            // 显示预览按钮，隐藏停止预览按钮
            previewRtspBtn.style.display = 'block';
            stopPreviewRtspBtn.style.display = 'none';

            fetch(`/api/project/${projectId}/rtsp/stop_preview`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateRtspStatus();
                    } else {
                        layer.msg('停止预览失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('停止预览时发生错误');
                });
        });

        manualCaptureBtn.addEventListener('click', function (e) {
            e.preventDefault();
            // 1. 检查视频是否正在播放
            if (videoPlayer.paused || videoPlayer.ended) {
                layer.msg('视频未播放，无法截图');
                return;
            }
            // 2. 创建Canvas元素，尺寸与视频实际分辨率一致
            const canvas = document.createElement('canvas');
            // 关键：使用videoWidth/videoHeight（视频原始分辨率）而非style宽高
            canvas.width = videoPlayer.videoWidth;
            canvas.height = videoPlayer.videoHeight;

            // 3. 将视频当前帧绘制到Canvas
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);

            // 4. 将Canvas转为PNG图片URL
            const screenshotUrl = canvas.toDataURL('image/png');

            // 5. 发送截图数据到服务器保存
            fetch(`/api/project/${projectId}/rtsp/manual_capture`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    screenshot_url: screenshotUrl
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        layer.msg('截图已保存');
                        updateRtspStatus();
                    } else {
                        layer.msg('截图保存失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('截图保存时发生错误');
                });
        });

        // RTSP预览功能
        previewRtspBtn.addEventListener('click', function (e) {
            e.preventDefault();

            const rtspUrl = document.getElementById('rtspUrl').value;
            if (!rtspUrl) {
                layer.msg('请先输入RTSP地址');
                return;
            }
            fetch(`/api/project/${projectId}/rtsp/preview`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    rtsp_url: rtspUrl
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let mu38_url = data.data.mu38_url
                        layer.msg('预览成功: ' + mu38_url);
                        videoPlayerContainer.style.display = 'block';
                        initHLSPlayer(mu38_url);
                        // 显示停止预览按钮，隐藏预览按钮
                        stopPreviewRtspBtn.style.display = 'block';
                        previewRtspBtn.style.display = 'none';
                    } else {
                        layer.msg('预览失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('预览时发生错误');
                });
        });

        // 停止RTSP截图
        stopRtspBtn.addEventListener('click', function () {
            stopRtspBtn.disabled = true;
            stopRtspBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 停止中...';

            fetch(`/api/project/${projectId}/rtsp/stop`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        startRtspBtn.disabled = false;
                        stopRtspBtn.disabled = true;
                        stopRtspBtn.innerHTML = '<i class="fas fa-stop"></i> 停止截图';
                        startRtspBtn.innerHTML = '<i class="fas fa-play"></i> 开始截图（自动）';
                        updateRtspStatus();
                    } else {
                        layer.msg('停止失败: ' + data.message);
                        stopRtspBtn.disabled = false;
                        stopRtspBtn.innerHTML = '<i class="fas fa-stop"></i> 停止截图';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('停止截图时发生错误');
                    stopRtspBtn.disabled = false;
                    stopRtspBtn.innerHTML = '<i class="fas fa-stop"></i> 停止截图';
                });
        });

        // 查找ONVIF设备
        discoverBtn.addEventListener('click', function () {
            discoverBtn.disabled = true;
            discoverBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 搜索中...';

            fetch(`/api/onvif/discover`, {
                method: 'GET'
            })
                .then(response => response.json())
                .then(data => {
                    discoverBtn.disabled = false;
                    discoverBtn.innerHTML = '<i class="fas fa-search"></i> 查找摄像头';

                    if (data.success) {
                        if (data.devices && data.devices.length > 0) {
                            onvifDevices.style.display = 'block';
                            devicesList.innerHTML = '';

                            data.devices.forEach(device => {
                                const deviceDiv = document.createElement('div');
                                deviceDiv.className = 'card mb-2';
                                deviceDiv.innerHTML = `
                            <div class="card-body">
                                <h6 class="card-title">${device.name || '未知设备'}</h6>
                                <p class="card-text">
                                    IP: ${device.ip}<br>
                                    端口: ${device.port}
                                </p>
                                <button class="btn btn-sm btn-primary select-device-btn" 
                                        data-ip="${device.ip}" 
                                        data-port="${device.port}">
                                    选择设备
                                </button>
                            </div>
                        `;
                                devicesList.appendChild(deviceDiv);
                            });

                            // 绑定选择设备按钮事件
                            document.querySelectorAll('.select-device-btn').forEach(btn => {
                                btn.addEventListener('click', function () {
                                    const ip = this.getAttribute('data-ip');
                                    const port = this.getAttribute('data-port');

                                    document.getElementById('deviceIp').value = ip;
                                    document.getElementById('devicePort').value = port;

                                    onvifDevices.style.display = 'none';
                                    onvifFormContainer.style.display = 'block';
                                });
                            });
                        } else {
                            layer.msg('未发现ONVIF设备');
                        }
                    } else {
                        layer.msg('搜索失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('搜索设备时发生错误');
                    discoverBtn.disabled = false;
                    discoverBtn.innerHTML = '<i class="fas fa-search"></i> 查找摄像头';
                });
        });

        // ONVIF登录表单提交
        onvifLoginForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const deviceIp = document.getElementById('deviceIp').value;
            const devicePort = document.getElementById('devicePort').value;
            const username = document.getElementById('onvifUsername').value;
            const password = document.getElementById('onvifPassword').value;

            const loginBtn = onvifLoginForm.querySelector('button[type="submit"]');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 登录中...';

            fetch(`/api/onvif/${deviceIp}/${devicePort}/profiles`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
                .then(response => response.json())
                .then(data => {
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> 登录设备';

                    if (data.success) {
                        if (data.profiles && data.profiles.length > 0) {
                            profilesContainer.style.display = 'block';
                            profilesList.innerHTML = '';

                            data.profiles.forEach(profile => {
                                const profileDiv = document.createElement('div');
                                profileDiv.className = 'card mb-2';
                                profileDiv.innerHTML = `
                            <div class="card-body">
                                <h6 class="card-title">${profile.name}</h6>
                                <p class="card-text">
                                    Token: ${profile.token}
                                </p>
                                <button class="btn btn-sm btn-primary select-profile-btn" 
                                        data-token="${profile.token}">
                                    选择通道
                                </button>
                            </div>
                        `;
                                profilesList.appendChild(profileDiv);
                            });

                            // 绑定选择通道按钮事件
                            document.querySelectorAll('.select-profile-btn').forEach(btn => {
                                btn.addEventListener('click', function () {
                                    const token = this.getAttribute('data-token');
                                    document.getElementById('selectedProfile').value = token;
                                });
                            });
                        } else {
                            layer.msg('该设备没有可用的摄像头通道');
                        }
                    } else {
                        layer.msg('登录失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('登录设备时发生错误');
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> 登录设备';
                });
        });

        // ONVIF截图表单提交
        onvifCaptureForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const deviceIp = document.getElementById('deviceIp').value;
            const devicePort = document.getElementById('devicePort').value;
            const username = document.getElementById('onvifUsername').value;
            const password = document.getElementById('onvifPassword').value;
            const profileToken = document.getElementById('selectedProfile').value;
            const interval = parseInt(document.getElementById('onvifInterval').value);
            const maxCount = parseInt(document.getElementById('onvifMaxCount').value);

            if (!profileToken) {
                layer.msg('请先选择摄像头通道');
                return;
            }

            startOnvifBtn.disabled = true;
            startOnvifBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 启动中...';

            fetch(`/api/project/${projectId}/onvif/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    device_ip: deviceIp,
                    device_port: devicePort,
                    username: username,
                    password: password,
                    profile_token: profileToken,
                    interval: interval,
                    max_count: maxCount
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        stopOnvifBtn.disabled = false;
                        updateOnvifStatus(profileToken);
                        startOnvifBtn.innerHTML = '<i class="fas fa-play"></i> 开始截图';
                    } else {
                        layer.msg('启动失败: ' + data.message);
                        startOnvifBtn.disabled = false;
                        startOnvifBtn.innerHTML = '<i class="fas fa-play"></i> 开始截图';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('启动截图时发生错误');
                    startOnvifBtn.disabled = false;
                    startOnvifBtn.innerHTML = '<i class="fas fa-play"></i> 开始截图';
                });
        });

        // 停止ONVIF截图
        stopOnvifBtn.addEventListener('click', function () {
            const profileToken = document.getElementById('selectedProfile').value;

            stopOnvifBtn.disabled = true;
            stopOnvifBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 停止中...';

            fetch(`/api/project/${projectId}/onvif/stop`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    profile_token: profileToken
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        startOnvifBtn.disabled = false;
                        stopOnvifBtn.disabled = true;
                        stopOnvifBtn.innerHTML = '<i class="fas fa-stop"></i> 停止截图';
                        updateOnvifStatus(profileToken);
                    } else {
                        layer.msg('停止失败: ' + data.message);
                        stopOnvifBtn.disabled = false;
                        stopOnvifBtn.innerHTML = '<i class="fas fa-stop"></i> 停止截图';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('停止截图时发生错误');
                    stopOnvifBtn.disabled = false;
                    stopOnvifBtn.innerHTML = '<i class="fas fa-stop"></i> 停止截图';
                });
        });

        // 刷新状态
        refreshStatusBtn.addEventListener('click', function () {
            updateRtspStatus();
            if (document.getElementById('selectedProfile').value) {
                updateOnvifStatus(document.getElementById('selectedProfile').value);
            }
        });
        // 初始化HLS播放器（修复版）
        function initHLSPlayer(m3u8Url) {
            // 安全检查1：video元素是否存在
            if (!videoPlayer) {
                layer.msg("未找到视频播放容器", { icon: 2 });
                return;
            }
            // 安全检查2：m3u8地址是否有效
            if (!m3u8Url || !m3u8Url.startsWith('http')) {
                layer.msg("无效的m3u8播放地址", { icon: 2 });
                return;
            }

            // 关键修复：先销毁旧的HLS实例（避免重复初始化）
            if (hlsInstance) {
                console.log("销毁旧的HLS实例");
                hlsInstance.destroy();
                hlsInstance = null;
            }
            // 清空video原有资源
            videoPlayer.pause();
            videoPlayer.src = '';
            videoSource.src = '';

            // 关键修复：先检查window.Hls是否存在，再判断支持性
            if (window.Hls && Hls.isSupported()) {
                try {
                    // 初始化HLS实例，优化实时性配置
                    hlsInstance = new Hls({
                        maxBufferLength: 10,  // 最大缓冲区长度（秒），越小越实时
                        maxMaxBufferLength: 30
                    });

                    // 监听HLS错误
                    hlsInstance.on(Hls.Events.ERROR, function (event, data) {
                        console.error("HLS播放错误：", data);
                        // 非致命错误不弹窗，仅打印
                        if (!data.fatal) {
                            console.warn("非致命HLS错误：", data.details);
                            return;
                        }
                        // 致命错误处理
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                layer.msg("视频流连接失败，正在重试...", { icon: 2, time: 2000 });
                                hlsInstance.stopLoad();
                                setTimeout(() => hlsInstance.startLoad(), 1000);
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                layer.msg("视频解码失败，正在恢复...", { icon: 2, time: 2000 });
                                hlsInstance.recoverMediaError();
                                break;
                            default:
                                layer.msg("视频播放出错：" + (data.details || "未知错误"), { icon: 2 });
                                hlsInstance.destroy();
                                hlsInstance = null;
                                break;
                        }
                    });

                    // 加载m3u8并绑定到video
                    hlsInstance.loadSource(m3u8Url);
                    hlsInstance.attachMedia(videoPlayer);

                    // 监听清单解析完成
                    hlsInstance.on(Hls.Events.MANIFEST_PARSED, function () {
                        console.log("HLS流解析成功，准备播放");
                        videoPlayer.play().catch(err => {
                            if (err.name === 'NotAllowedError') {
                                layer.msg("浏览器限制自动播放，请手动点击播放按钮", { icon: 1 });
                            } else {
                                layer.msg("播放失败：" + err.message, { icon: 2 });
                            }
                        });
                    });
                } catch (e) {
                    console.error("初始化HLS失败：", e);
                    layer.msg("初始化视频播放器失败：" + e.message, { icon: 2 });
                }
            }
            // 兼容Safari原生HLS
            else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                console.log("浏览器原生支持HLS，直接加载");
                videoPlayer.src = m3u8Url;
                videoPlayer.load();
                // 监听加载完成
                videoPlayer.addEventListener('loadedmetadata', function () {
                    videoPlayer.play().catch(err => {
                        if (err.name === 'NotAllowedError') {
                            layer.msg("浏览器限制自动播放，请手动点击播放按钮", { icon: 1 });
                        } else {
                            layer.msg("播放失败：" + err.message, { icon: 2 });
                        }
                    });
                }, { once: true });
                // 监听原生错误
                videoPlayer.addEventListener('error', function (err) {
                    console.error("原生HLS错误：", err);
                    layer.msg("视频播放失败，请检查流地址是否有效", { icon: 2 });
                }, { once: true });
            } else {
                layer.msg("您的浏览器不支持HLS视频播放，请使用Chrome/Firefox/Safari（版本≥80）", { icon: 0 });
            }
        }
        // 更新RTSP状态
        function updateRtspStatus() {
            // 自动截图状态接口
            fetch(`/api/project/${projectId}/rtsp/status`)
                .then(response => response.json())
                .then(data => {
                    if (data.status) {
                        // 更新状态显示
                        if (data.status.running) {
                            rtspStatus.innerHTML = '<span class="status-indicator status-running"></span> 运行中';
                            startRtspBtn.innerHTML = '<i class="fas fa-play"></i> 正在运行';


                            startRtspBtn.disabled = true;
                            stopRtspBtn.disabled = false;
                        } else {
                            rtspStatus.innerHTML = '<span class="status-indicator status-stopped"></span> 已停止';
                            startRtspBtn.disabled = false;
                            stopRtspBtn.disabled = true;
                        }

                        // 更新计数
                        rtspCapturedCount.textContent = data.status.captured_count || 0;
                        rtspMaxCount.textContent = data.status.max_count || 0;
                    } else {
                        rtspStatus.innerHTML = '<span class="status-indicator status-stopped"></span> 未运行';
                        startRtspBtn.disabled = false;
                        stopRtspBtn.disabled = true;
                        rtspCapturedCount.textContent = '0';
                        rtspMaxCount.textContent = '0';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            // 预览状态接口（可选）
            fetch(`/api/project/${projectId}/rtsp/preview_status`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && !data.status.error_msg) {
                        console.log('RTSP预览状态：', data.status);
                        // 如果正在预览，确保视频播放器显示
                        // 如果显示器已经在播放同一个URL的流，就不重复初始化
                        if (!hlsInstance) {
                            videoPlayerContainer.style.display = 'block';
                            initHLSPlayer(data.status.mu38_url);
                            // 显示停止预览按钮，隐藏预览按钮
                            stopPreviewRtspBtn.style.display = 'inline-block';
                            previewRtspBtn.style.display = 'none';
                        }
                        rtspPreviewStatus.innerHTML = '<span class="status-indicator status-running"></span> 预览中';
                    } else {
                        // 预览接口返回错误，隐藏视频播放器
                        videoPlayerContainer.style.display = 'none';
                        // 显示预览按钮，隐藏停止预览按钮
                        previewRtspBtn.style.display = 'inline-block';
                        stopPreviewRtspBtn.style.display = 'none';
                        // 移除视频源
                        if (hlsInstance) {
                            hlsInstance.destroy();
                            hlsInstance = null;
                        }
                        rtspPreviewStatus.innerHTML = '<span class="status-indicator status-stopped"></span> 未运行';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // 更新ONVIF状态
        function updateOnvifStatus(profileToken) {
            fetch(`/api/project/${projectId}/onvif/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    profile_token: profileToken
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status) {
                        // 更新状态显示
                        if (data.status.running) {
                            onvifStatus.innerHTML = '<span class="status-indicator status-running"></span> 运行中';
                            startOnvifBtn.disabled = true;
                            stopOnvifBtn.disabled = false;
                        } else {
                            onvifStatus.innerHTML = '<span class="status-indicator status-stopped"></span> 已停止';
                            startOnvifBtn.disabled = false;
                            stopOnvifBtn.disabled = true;
                        }

                        // 更新计数
                        onvifCapturedCount.textContent = data.status.captured_count || 0;
                        onvifMaxCount.textContent = data.status.max_count || 0;
                    } else {
                        onvifStatus.innerHTML = '<span class="status-indicator status-stopped"></span> 未运行';
                        startOnvifBtn.disabled = false;
                        stopOnvifBtn.disabled = true;
                        onvifCapturedCount.textContent = '0';
                        onvifMaxCount.textContent = '0';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // 定期更新状态
        setInterval(function () {
            updateRtspStatus();
            if (document.getElementById('selectedProfile').value) {
                updateOnvifStatus(document.getElementById('selectedProfile').value);
            }
        }, 5000); // 每5秒更新一次状态
    });
</script>
{% endblock %}