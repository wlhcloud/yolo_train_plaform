{% block extra_css %}
<style>
    .capture-card {
        transition: transform 0.2s;
    }

    .capture-card:hover {
        transform: scale(1.02);
    }

    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }

    .status-running {
        background-color: #28a745;
    }

    .status-stopped {
        background-color: #dc3545;
    }

    .status-pending {
        background-color: #ffc107;
    }

    .video-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 15px;
    }

    #videoPlayer {
        width: 100%;
        height: 400px;
        background: #000;
    }

    .video-controls {
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
    }

    .capture-controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }

    .current-time {
        font-family: monospace;
        font-size: 14px;
    }

    .video-info {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 14px;
    }

    .manual-capture-btn {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        border: none;
        transition: all 0.3s;
    }

    .manual-capture-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(37, 117, 252, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div style="overflow: hidden;">
    <div class="row">
        <div class="col-md-8">
            <!-- 视频播放和手动截图区域 -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>视频截图</span>
                        <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#manualHelp" aria-expanded="false" aria-controls="manualHelp">
                            <i class="fas fa-question-circle"></i> 帮助
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="collapse" id="manualHelp">
                        <div class="alert alert-info">
                            <h6>手动截图说明：</h6>
                            <ul>
                                <li>上传视频文件后，视频将在下方播放器中加载</li>
                                <li>使用播放器控制条可以控制视频播放进度</li>
                                <li>点击"手动截图"按钮可以截取当前视频帧</li>
                                <li>截图会自动保存到当前项目中</li>
                            </ul>
                        </div>
                    </div>

                    <!-- 文件上传区域 -->
                    <div class="mb-4">
                        <label for="videoFile" class="form-label">选择视频文件</label>
                        <input type="file" class="form-control" id="videoFile" name="videoFile" accept="video/*">
                        <div class="form-text">支持 MP4, AVI, MOV, WMV 等常见视频格式</div>
                    </div>

                    <!-- 视频播放器区域 -->
                    <div id="videoPlayerContainer" style="display: none;">
                        <div class="video-container">
                            <video id="videoPlayer" controls>
                                <source id="videoSource" src="">
                                您的浏览器不支持视频播放
                            </video>
                        </div>

                        <!-- 视频信息 -->
                        <div class="video-info">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>当前视频：</strong>
                                    <span id="currentVideoName">未选择</span>
                                </div>
                                <div class="col-md-6 text-end">
                                    <span class="current-time">
                                        时长：<span id="videoDuration">00:00</span> |
                                        当前：<span id="currentTime">00:00</span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- 手动截图控制 -->
                        <div class="capture-controls">
                            <button class="btn btn-primary manual-capture-btn" id="manualCaptureBtn">
                                <i class="fas fa-camera"></i> 手动截图
                            </button>
                        </div>
                    </div>

                    <!-- 截图预览区域 -->
                    <div id="capturePreview" class="mt-4" style="display: none;">
                        <h6>最近截图预览</h6>
                        <div id="previewContainer" class="row mt-2">
                            <!-- 截图预览将动态添加到这里 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 自动截图配置区域 -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>自动截图配置</span>
                        <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#autoHelp" aria-expanded="false" aria-controls="autoHelp">
                            <i class="fas fa-question-circle"></i> 帮助
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="collapse" id="autoHelp">
                        <div class="alert alert-info">
                            <h6>自动截图说明：</h6>
                            <ul>
                                <li>设置截图间隔和总数量后，系统会自动按时间间隔截图</li>
                                <li>截图会从视频开始自动进行</li>
                                <li>可以通过停止按钮随时中断截图过程</li>
                                <li>截图会自动保存到当前项目中</li>
                            </ul>
                        </div>
                    </div>

                    <form id="autoCaptureForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="interval" class="form-label">截图间隔（秒）</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="interval" min="1" max="3600"
                                            value="5" required>
                                        <span class="input-group-text">秒</span>
                                    </div>
                                    <div class="form-text">每隔多少秒截图一次</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="maxCount" class="form-label">总截图数量</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="maxCount" min="1" max="10000"
                                            value="10" required>
                                        <span class="input-group-text">张</span>
                                    </div>
                                    <div class="form-text">总共需要截图的数量</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="startTime" class="form-label">开始时间</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="startTime" min="0" value="0"
                                            step="1">
                                        <span class="input-group-text">秒</span>
                                    </div>
                                    <div class="form-text">从视频的哪个时间开始截图（默认为0）</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="endTime" class="form-label">结束时间</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="endTime" min="1" step="1">
                                        <span class="input-group-text">秒</span>
                                    </div>
                                    <div class="form-text">截到视频的哪个时间（留空则到视频结束）</div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" id="startAutoCaptureBtn">
                                <i class="fas fa-play"></i> 开始自动截图
                            </button>
                            <button class="btn btn-danger" id="stopAutoCaptureBtn" disabled>
                                <i class="fas fa-stop"></i> 停止自动截图
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 状态显示区域 -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    截图状态
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6>自动截图状态</h6>
                        <div id="autoCaptureStatus" class="mb-2">
                            <span class="status-indicator status-stopped"></span>
                            <span>未运行</span>
                        </div>
                        <div>
                            <small>已截图: <span id="autoCapturedCount">0</span>/<span id="autoMaxCount">0</span></small>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h6>手动截图状态</h6>
                        <div id="manualCaptureStatus" class="mb-2">
                            <span class="status-indicator status-running"></span>
                            <span>正常</span>
                        </div>
                        <div>
                            <small>已截图: <span id="manualCapturedCount">0</span></small>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h6>最近活动</h6>
                        <div id="recentActivity" style="max-height: 150px; overflow-y: auto;">
                            <div class="text-muted small">暂无活动记录</div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button class="btn btn-sm btn-outline-primary" id="refreshAllStatusBtn">
                            <i class="fas fa-sync"></i> 刷新状态
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(function () {
        const projectId = '{{ project.id }}';
        let currentVideoFile = null;
        let autoCaptureInterval = null;

        // DOM 元素
        const videoFileInput = document.getElementById('videoFile');
        const videoPlayerContainer = document.getElementById('videoPlayerContainer');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoSource = document.getElementById('videoSource');
        const currentVideoName = document.getElementById('currentVideoName');
        const videoDuration = document.getElementById('videoDuration');
        const currentTime = document.getElementById('currentTime');
        const manualCaptureBtn = document.getElementById('manualCaptureBtn');
        const batchCaptureBtn = document.getElementById('batchCaptureBtn');
        const captureCountInput = document.getElementById('captureCount');
        const capturePreview = document.getElementById('capturePreview');
        const previewContainer = document.getElementById('previewContainer');

        // 自动截图元素
        const autoCaptureForm = document.getElementById('autoCaptureForm');
        const startAutoCaptureBtn = document.getElementById('startAutoCaptureBtn');
        const stopAutoCaptureBtn = document.getElementById('stopAutoCaptureBtn');
        const intervalInput = document.getElementById('interval');
        const maxCountInput = document.getElementById('maxCount');
        const startTimeInput = document.getElementById('startTime');
        const endTimeInput = document.getElementById('endTime');

        // 状态显示元素
        const autoCaptureStatus = document.getElementById('autoCaptureStatus');
        const autoCapturedCount = document.getElementById('autoCapturedCount');
        const autoMaxCount = document.getElementById('autoMaxCount');
        const autoCaptureProgress = document.getElementById('autoCaptureProgress');
        const manualCapturedCount = document.getElementById('manualCapturedCount');
        const totalManualCount = document.getElementById('totalManualCount');
        const recentActivity = document.getElementById('recentActivity');
        const refreshAllStatusBtn = document.getElementById('refreshAllStatusBtn');

        // 视频文件选择事件
        videoFileInput.addEventListener('change', function (e) {
            if (this.files && this.files[0]) {
                currentVideoFile = this.files[0];
                const videoURL = URL.createObjectURL(currentVideoFile);

                // 设置视频源
                videoSource.src = videoURL;
                videoPlayer.load();

                // 显示视频播放器
                videoPlayerContainer.style.display = 'block';
                currentVideoName.textContent = currentVideoFile.name;

                // 设置视频加载完成后的回调
                videoPlayer.addEventListener('loadedmetadata', function () {
                    const duration = videoPlayer.duration;
                    videoDuration.textContent = formatTime(duration);

                    // 设置结束时间默认值
                    if (!endTimeInput.value || endTimeInput.value > duration) {
                        endTimeInput.value = Math.floor(duration);
                    }
                });

                // 更新当前时间
                videoPlayer.addEventListener('timeupdate', function () {
                    currentTime.textContent = formatTime(videoPlayer.currentTime);
                });

                // 清除旧的截图预览
                clearPreview();
                capturePreview.style.display = 'none';
            }
        });

        // 格式化时间显示
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 手动截图
        manualCaptureBtn.addEventListener('click', function () {
            if (!currentVideoFile) {
                layer.msg('请先选择视频文件！');
                return;
            }

            // 创建FormData并添加截图数据
            const formData = new FormData();
            formData.append('video', currentVideoFile);
            formData.append('video_current_time', videoPlayer.currentTime);

            // 可以在这里添加canvas截图逻辑，或者调用后端API
            // 这里假设后端API可以处理视频截图
            manualCaptureBtn.disabled = true;
            manualCaptureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 截图中...';

            fetch(`/api/project/${projectId}/video/manual_capture`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        layer.msg('截图成功！');
                        addActivity('手动截图成功', videoPlayer.currentTime);
                        updateManualStats();
                        // showPreview(data.image_url);
                    } else {
                        layer.msg('截图失败: ' + data.message);
                    }
                    manualCaptureBtn.disabled = false;
                    manualCaptureBtn.innerHTML = '<i class="fas fa-camera"></i> 手动截图';
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('截图时发生错误');
                    manualCaptureBtn.disabled = false;
                    manualCaptureBtn.innerHTML = '<i class="fas fa-camera"></i> 手动截图';
                });
        });

        // 清除预览
        function clearPreview() {
            previewContainer.innerHTML = '';
        }

        // 更新手动截图统计
        function updateManualStats() {
            manualCapturedCount.textContent = parseInt(manualCapturedCount.textContent) + 1;
        }

        // 自动截图开始
        startAutoCaptureBtn.addEventListener('click', function (e) {
            e.preventDefault();

            if (!currentVideoFile) {
                layer.msg('请先选择视频文件！');
                return;
            }

            const formData = new FormData();
            formData.append('video', currentVideoFile);
            formData.append('interval', intervalInput.value || 5);
            formData.append('max_count', maxCountInput.value || 10);
            formData.append('start_time', startTimeInput.value || 0);

            if (endTimeInput.value) {
                formData.append('end_time', endTimeInput.value);
            }

            startAutoCaptureBtn.disabled = true;
            startAutoCaptureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 启动中...';

            fetch(`/api/project/${projectId}/video/start_auto_capture`, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        stopAutoCaptureBtn.disabled = false;
                        updateAutoCaptureStatus();
                        addActivity('开始自动截图');
                    } else {
                        layer.msg('启动失败: ' + data.message);
                        startAutoCaptureBtn.disabled = false;
                        startAutoCaptureBtn.innerHTML = '<i class="fas fa-play"></i> 开始自动截图';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('启动截图时发生错误');
                    startAutoCaptureBtn.disabled = false;
                    startAutoCaptureBtn.innerHTML = '<i class="fas fa-play"></i> 开始自动截图';
                });
        });

        // 停止自动截图
        stopAutoCaptureBtn.addEventListener('click', function () {
            stopAutoCaptureBtn.disabled = true;
            stopAutoCaptureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 停止中...';

            fetch(`/api/project/${projectId}/video/stop_auto_capture`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        startAutoCaptureBtn.disabled = false;
                        stopAutoCaptureBtn.disabled = true;
                        stopAutoCaptureBtn.innerHTML = '<i class="fas fa-stop"></i> 停止自动截图';
                        updateAutoCaptureStatus();
                        addActivity('停止自动截图');
                    } else {
                        layer.msg('停止失败: ' + data.message);
                        stopAutoCaptureBtn.disabled = false;
                        stopAutoCaptureBtn.innerHTML = '<i class="fas fa-stop"></i> 停止自动截图';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('停止截图时发生错误');
                    stopAutoCaptureBtn.disabled = false;
                    stopAutoCaptureBtn.innerHTML = '<i class="fas fa-stop"></i> 停止自动截图';
                });
        });

        // 更新自动截图状态
        function updateAutoCaptureStatus() {
            fetch(`/api/project/${projectId}/video/status`)
                .then(response => response.json())
                .then(data => {
                    if (data.status) {
                        const captured = data.status.captured_count || 0;
                        const max = data.status.max_count || 1;
                        const progress = (captured / max) * 100;

                        if (data.status.running) {
                            autoCaptureStatus.innerHTML = '<span class="status-indicator status-running"></span> 运行中';
                            startAutoCaptureBtn.disabled = true;
                            startAutoCaptureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 运行中...';
                            stopAutoCaptureBtn.disabled = false;
                        } else {
                            autoCaptureStatus.innerHTML = '<span class="status-indicator status-stopped"></span> 已停止';
                            startAutoCaptureBtn.disabled = false;
                            startAutoCaptureBtn.innerHTML = '<i class="fas fa-play"></i> 开始自动截图';
                            stopAutoCaptureBtn.disabled = true;
                        }

                        autoCapturedCount.textContent = captured;
                        autoMaxCount.textContent = max;
                        autoCaptureProgress.style.width = `${progress}%`;
                    } else {
                        autoCaptureStatus.innerHTML = '<span class="status-indicator status-stopped"></span> 未运行';
                        startAutoCaptureBtn.disabled = false;
                        startAutoCaptureBtn.innerHTML = '<i class="fas fa-play"></i> 开始自动截图';
                        stopAutoCaptureBtn.disabled = true;
                        autoCapturedCount.textContent = '0';
                        autoMaxCount.textContent = '0';
                        autoCaptureProgress.style.width = '0%';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // 刷新所有状态
        refreshAllStatusBtn.addEventListener('click', function () {
            updateAutoCaptureStatus();
            // 这里可以添加获取手动截图统计的API调用
            addActivity('手动刷新状态');
            layer.msg('状态已刷新');
        });

        // 添加活动记录
        function addActivity(message, captureTime = null) {
            // 如果之前显示的是"暂无活动记录"，则移除
            const noActivity = recentActivity.querySelector('.text-muted');
            if (noActivity && noActivity.textContent === '暂无活动记录') {
                recentActivity.removeChild(noActivity);
            }

            const now = new Date();
            const timeStr = now.toLocaleTimeString();

            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item mb-2 pb-2 border-bottom';
            activityItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <span class="small">${message}</span>
                    <span class = 'small'>${captureTime !== null ? '截图时间: ' + formatTime(captureTime) : ''}</span>
                    <small class="text-muted">${timeStr}</small>
                </div>
            `;

            // 限制只显示5条记录
            if (recentActivity.children.length >= 5) {
                recentActivity.removeChild(recentActivity.lastChild);
            }

            recentActivity.insertBefore(activityItem, recentActivity.firstChild);
        }

        // 初始化
        function init() {
            updateAutoCaptureStatus();

            // 设置视频时长显示的初始值
            videoPlayer.addEventListener('loadedmetadata', function () {
                videoDuration.textContent = formatTime(videoPlayer.duration);
            });
        }

        // 定期更新状态
        setInterval(function () {
            updateAutoCaptureStatus();
        }, 5000);

        // 页面加载完成后初始化
        init();
    });
</script>
{% endblock %}