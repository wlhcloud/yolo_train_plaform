<!-- Bootstrap CSS -->
<script src="/static/js/jquery-2.1.4.min.js"></script>
<link href="/static/css/bootstrap.min.css" rel="stylesheet">
<script src="/static/js/layer/layer.js"></script>
<!-- Font Awesome -->
<link rel="stylesheet" href="/static/css/all.min.css">
{% block extra_css %}
<style>
    .capture-card {
        transition: transform 0.2s;
    }

    .capture-card:hover {
        transform: scale(1.02);
    }

    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }

    .status-running {
        background-color: #28a745;
    }

    .status-stopped {
        background-color: #dc3545;
    }

    .status-pending {
        background-color: #ffc107;
    }

    .video-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 15px;
    }

    #videoPlayer {
        width: 100%;
        height: 400px;
        background: #000;
    }

    .video-controls {
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
    }

    .capture-controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .current-time {
        font-family: monospace;
        font-size: 14px;
    }

    .video-info {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 14px;
    }

    .manual-capture-btn {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        border: none;
        transition: all 0.3s;
    }

    .manual-capture-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(37, 117, 252, 0.4);
    }

    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
    }

    .upload-area:hover {
        border-color: #0d6efd;
        background: #e7f1ff;
    }

    .upload-area.dragover {
        border-color: #0d6efd;
        background: #e7f1ff;
        transform: scale(1.02);
    }

    .upload-progress {
        margin-top: 15px;
        display: none;
    }

    .video-thumbnail {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
    }

    .video-list-item {
        transition: all 0.2s;
        cursor: pointer;
    }

    .video-list-item:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }

    .video-list-item.active {
        background-color: #e7f1ff;
        border-left: 4px solid #0d6efd;
    }

    .preview-image {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
        transition: transform 0.2s;
    }

    .preview-image:hover {
        transform: scale(1.05);
    }
</style>
{% endblock %}

{% block content %}
<div style="overflow: hidden;">
    <div class="row">
        <div class="col-md-8">
            <!-- 视频上传区域 -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>视频上传</span>
                        <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#uploadHelp" aria-expanded="false" aria-controls="uploadHelp">
                            <i class="fas fa-question-circle"></i> 帮助
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="collapse" id="uploadHelp">
                        <div class="alert alert-info">
                            <h6>视频上传说明：</h6>
                            <ul>
                                <li>支持 MP4, AVI, MOV, WMV 等常见视频格式</li>
                                <li>最大上传大小：1GB</li>
                                <li>上传后视频将保存在当前项目中</li>
                                <li>可以上传多个视频，在下方视频列表中选择</li>
                            </ul>
                        </div>
                    </div>

                    <!-- 拖拽上传区域 -->
                    <div id="uploadArea" class="upload-area">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5>拖放视频文件到这里</h5>
                        <p class="text-muted">或点击选择文件</p>
                        <input type="file" id="videoUploadInput" class="d-none" accept="video/*" multiple>
                        <button class="btn btn-primary mt-2" id="selectFileBtn">
                            <i class="fas fa-folder-open"></i> 选择文件
                        </button>
                    </div>

                    <!-- 上传进度 -->
                    <div id="uploadProgress" class="upload-progress">
                        <div class="d-flex justify-content-between mb-1">
                            <span id="uploadFileName">正在上传...</span>
                            <span id="uploadPercent">0%</span>
                        </div>
                        <div class="progress">
                            <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-2">
                            <button class="btn btn-sm btn-danger" id="cancelUploadBtn">
                                <i class="fas fa-times"></i> 取消上传
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 视频播放和手动截图区域 -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>视频播放与手动截图</span>
                        <span id="currentVideoInfo" class="badge bg-info" style="display: none;"></span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 视频选择列表（当有多个视频时显示） -->
                    <div id="videoListContainer" class="mb-3" style="display: none;">
                        <h6>选择视频：</h6>
                        <div id="videoList" class="list-group">
                            <!-- 视频列表将动态生成 -->
                        </div>
                    </div>

                    <!-- 视频播放器区域 -->
                    <div id="videoPlayerContainer" style="display: none;">
                        <div class="video-container">
                            <video id="videoPlayer" controls>
                                <source id="videoSource" src="">
                                您的浏览器不支持视频播放
                            </video>
                        </div>

                        <!-- 视频信息 -->
                        <div class="video-info">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>当前视频：</strong>
                                    <span id="currentVideoName">未选择</span>
                                </div>
                                <div class="col-md-6 text-end">
                                    <span class="current-time">
                                        时长：<span id="videoDuration">00:00</span> |
                                        当前：<span id="currentTime">00:00</span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- 手动截图控制 -->
                        <div class="capture-controls">
                            <button class="btn btn-primary manual-capture-btn" id="manualCaptureBtn" disabled>
                                <i class="fas fa-camera"></i> 手动截图
                            </button>
                            <div class="d-flex align-items-center">
                                <label for="captureCount" class="me-2 mb-0">连续截图：</label>
                                <input type="number" id="captureCount" class="form-control form-control-sm"
                                    style="width: 80px;" min="1" max="10" value="1">
                                <span class="ms-2">张</span>
                            </div>
                            <button class="btn btn-outline-success" id="batchCaptureBtn" disabled>
                                <i class="fas fa-camera-retro"></i> 批量截图
                            </button>
                            <div class="d-flex align-items-center">
                                <label for="jumpTime" class="me-2 mb-0">跳转到：</label>
                                <div class="input-group input-group-sm" style="width: 150px;">
                                    <input type="number" id="jumpMinute" class="form-control" placeholder="分" min="0"
                                        value="0">
                                    <span class="input-group-text">:</span>
                                    <input type="number" id="jumpSecond" class="form-control" placeholder="秒" min="0"
                                        max="59" value="0">
                                    <button class="btn btn-outline-secondary" type="button" id="jumpBtn">
                                        <i class="fas fa-forward"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 无视频提示 -->
                    <div id="noVideoMessage" class="text-center py-5">
                        <i class="fas fa-film fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">请先上传视频</h5>
                        <p class="text-muted">上传视频后，您可以在这里播放和截图</p>
                    </div>

                    <!-- 截图预览区域 -->
                    <div id="capturePreview" class="mt-4" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">截图预览</h6>
                            <button class="btn btn-sm btn-outline-secondary" id="clearPreviewBtn">
                                <i class="fas fa-trash"></i> 清空预览
                            </button>
                        </div>
                        <div id="previewContainer" class="row mt-2">
                            <!-- 截图预览将动态添加到这里 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 自动截图配置区域 -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>自动截图配置</span>
                        <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#autoHelp" aria-expanded="false" aria-controls="autoHelp">
                            <i class="fas fa-question-circle"></i> 帮助
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="collapse" id="autoHelp">
                        <div class="alert alert-info">
                            <h6>自动截图说明：</h6>
                            <ul>
                                <li>设置截图间隔和总数量后，系统会自动按时间间隔截图</li>
                                <li>截图会从视频开始自动进行</li>
                                <li>可以通过停止按钮随时中断截图过程</li>
                                <li>截图会自动保存到当前项目中</li>
                            </ul>
                        </div>
                    </div>

                    <!-- 视频选择（自动截图用） -->
                    <div class="mb-3" id="autoVideoSelectContainer" style="display: none;">
                        <label for="autoVideoSelect" class="form-label">选择视频</label>
                        <select class="form-select" id="autoVideoSelect">
                            <option value="">请选择视频</option>
                            <!-- 视频选项将动态添加 -->
                        </select>
                    </div>

                    <form id="autoCaptureForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="interval" class="form-label">截图间隔（秒）</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="interval" min="1" max="3600"
                                            value="5" required disabled>
                                        <span class="input-group-text">秒</span>
                                    </div>
                                    <div class="form-text">每隔多少秒截图一次</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="maxCount" class="form-label">总截图数量</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="maxCount" min="1" max="10000"
                                            value="10" required disabled>
                                        <span class="input-group-text">张</span>
                                    </div>
                                    <div class="form-text">总共需要截图的数量</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="startTime" class="form-label">开始时间</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="startTime" min="0" value="0"
                                            step="1" disabled>
                                        <span class="input-group-text">秒</span>
                                    </div>
                                    <div class="form-text">从视频的哪个时间开始截图（默认为0）</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="endTime" class="form-label">结束时间</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="endTime" min="1" step="1"
                                            disabled>
                                        <span class="input-group-text">秒</span>
                                    </div>
                                    <div class="form-text">截到视频的哪个时间（留空则到视频结束）</div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-primary flex-fill" id="startAutoCaptureBtn" disabled>
                                <i class="fas fa-play"></i> 开始自动截图
                            </button>
                            <button class="btn btn-danger flex-fill" id="stopAutoCaptureBtn" disabled>
                                <i class="fas fa-stop"></i> 停止自动截图
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 状态显示区域 -->
        <div class="col-md-4">
            <!-- 已上传视频列表 -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>已上传视频</span>
                        <span class="badge bg-secondary" id="videoCount">0个</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="uploadedVideosList" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-video-slash"></i>
                            <p class="mt-2">暂无视频</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 截图状态 -->
            <div class="card mb-4">
                <div class="card-header">
                    截图状态
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6>自动截图状态</h6>
                        <div id="autoCaptureStatus" class="mb-2">
                            <span class="status-indicator status-stopped"></span>
                            <span>未运行</span>
                        </div>
                        <div class="progress mb-2" style="height: 10px;">
                            <div id="autoCaptureProgress" class="progress-bar" role="progressbar" style="width: 0%">
                            </div>
                        </div>
                        <div class="text-center">
                            <small>已截图: <span id="autoCapturedCount">0</span>/<span id="autoMaxCount">0</span></small>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6>手动截图统计</h6>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>今日截图：</span>
                            <span class="badge bg-primary" id="todayManualCount">0</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>总计截图：</span>
                            <span class="badge bg-success" id="totalManualCount">0</span>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6>最近活动</h6>
                        <div id="recentActivity" style="max-height: 150px; overflow-y: auto;">
                            <div class="text-muted small">暂无活动记录</div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button class="btn btn-sm btn-outline-primary w-100" id="refreshAllStatusBtn">
                            <i class="fas fa-sync"></i> 刷新所有状态
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(function () {
        const projectId = '{{ project.id }}';
        let uploadedVideos = []; // 存储已上传的视频信息
        let currentVideoId = null; // 当前选中的视频ID
        let autoCaptureInterval = null;
        let uploadXHR = null; // 用于取消上传的XMLHttpRequest

        // DOM 元素
        const uploadArea = document.getElementById('uploadArea');
        const videoUploadInput = document.getElementById('videoUploadInput');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadPercent = document.getElementById('uploadPercent');
        const uploadFileName = document.getElementById('uploadFileName');
        const cancelUploadBtn = document.getElementById('cancelUploadBtn');

        const videoPlayerContainer = document.getElementById('videoPlayerContainer');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoSource = document.getElementById('videoSource');
        const currentVideoName = document.getElementById('currentVideoName');
        const videoDuration = document.getElementById('videoDuration');
        const currentTime = document.getElementById('currentTime');
        const manualCaptureBtn = document.getElementById('manualCaptureBtn');
        const batchCaptureBtn = document.getElementById('batchCaptureBtn');
        const captureCountInput = document.getElementById('captureCount');
        const jumpBtn = document.getElementById('jumpBtn');
        const jumpMinute = document.getElementById('jumpMinute');
        const jumpSecond = document.getElementById('jumpSecond');
        const noVideoMessage = document.getElementById('noVideoMessage');

        const capturePreview = document.getElementById('capturePreview');
        const previewContainer = document.getElementById('previewContainer');
        const clearPreviewBtn = document.getElementById('clearPreviewBtn');

        const videoListContainer = document.getElementById('videoListContainer');
        const videoList = document.getElementById('videoList');
        const currentVideoInfo = document.getElementById('currentVideoInfo');
        const uploadedVideosList = document.getElementById('uploadedVideosList');
        const videoCount = document.getElementById('videoCount');

        const autoVideoSelectContainer = document.getElementById('autoVideoSelectContainer');
        const autoVideoSelect = document.getElementById('autoVideoSelect');

        // 自动截图元素
        const autoCaptureForm = document.getElementById('autoCaptureForm');
        const startAutoCaptureBtn = document.getElementById('startAutoCaptureBtn');
        const stopAutoCaptureBtn = document.getElementById('stopAutoCaptureBtn');
        const intervalInput = document.getElementById('interval');
        const maxCountInput = document.getElementById('maxCount');
        const startTimeInput = document.getElementById('startTime');
        const endTimeInput = document.getElementById('endTime');

        // 状态显示元素
        const autoCaptureStatus = document.getElementById('autoCaptureStatus');
        const autoCapturedCount = document.getElementById('autoCapturedCount');
        const autoMaxCount = document.getElementById('autoMaxCount');
        const autoCaptureProgress = document.getElementById('autoCaptureProgress');
        const todayManualCount = document.getElementById('todayManualCount');
        const totalManualCount = document.getElementById('totalManualCount');
        const recentActivity = document.getElementById('recentActivity');
        const refreshAllStatusBtn = document.getElementById('refreshAllStatusBtn');

        // 1. 视频上传功能
        selectFileBtn.addEventListener('click', function () {
            videoUploadInput.click();
        });

        uploadArea.addEventListener('click', function () {
            videoUploadInput.click();
        });

        // 拖拽上传功能
        uploadArea.addEventListener('dragover', function (e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function (e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function (e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                videoUploadInput.files = files;
                handleVideoUpload(files[0]);
            }
        });

        videoUploadInput.addEventListener('change', function (e) {
            if (this.files && this.files.length > 0) {
                handleVideoUpload(this.files[0]);
            }
        });

        // 取消上传
        cancelUploadBtn.addEventListener('click', function () {
            if (uploadXHR) {
                uploadXHR.abort();
                uploadProgress.style.display = 'none';
                layer.msg('上传已取消');
            }
        });

        function handleVideoUpload(file) {
            // 检查文件类型
            if (!file.type.startsWith('video/')) {
                layer.msg('请选择视频文件！');
                return;
            }

            // 检查文件大小（限制1GB）
            if (file.size > 1024 * 1024 * 1024) {
                layer.msg('文件大小不能超过1GB！');
                return;
            }

            // 显示上传进度
            uploadProgress.style.display = 'block';
            uploadFileName.textContent = `正在上传：${file.name}`;
            uploadPercent.textContent = '0%';
            uploadProgressBar.style.width = '0%';

            // 创建FormData
            const formData = new FormData();
            formData.append('video', file);
            formData.append('project_id', projectId);

            // 使用XMLHttpRequest以便跟踪进度
            uploadXHR = new XMLHttpRequest();

            uploadXHR.upload.addEventListener('progress', function (e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    uploadPercent.textContent = percentComplete + '%';
                    uploadProgressBar.style.width = percentComplete + '%';
                }
            });

            uploadXHR.addEventListener('load', function () {
                if (uploadXHR.status === 200) {
                    try {
                        const response = JSON.parse(uploadXHR.responseText);
                        if (response.success) {
                            layer.msg('视频上传成功！');
                            addActivity(`上传视频：${file.name}`);
                            uploadProgress.style.display = 'none';

                            // 添加到已上传视频列表
                            addUploadedVideo(response.video);

                            // 如果是第一个视频，自动选中并播放
                            if (uploadedVideos.length === 1) {
                                selectVideo(response.video.id);
                            }
                        } else {
                            layer.msg('上传失败：' + response.message);
                        }
                    } catch (e) {
                        layer.msg('解析响应失败');
                    }
                } else {
                    layer.msg('上传失败，状态码：' + uploadXHR.status);
                }
            });

            uploadXHR.addEventListener('error', function () {
                layer.msg('上传过程中发生错误');
                uploadProgress.style.display = 'none';
            });

            uploadXHR.addEventListener('abort', function () {
                uploadProgress.style.display = 'none';
            });

            // 发送请求
            uploadXHR.open('POST', `/api/project/${projectId}/video/upload`);
            uploadXHR.send(formData);
        }

        // 2. 视频管理功能
        function addUploadedVideo(videoInfo) {
            // 添加到数组
            uploadedVideos.push(videoInfo);

            // 更新视频数量显示
            videoCount.textContent = `${uploadedVideos.length}个`;

            // 更新已上传视频列表
            updateUploadedVideosList();

            // 更新视频选择下拉框
            updateVideoSelectOptions();

            // 如果这是第一个视频，显示视频列表
            if (uploadedVideos.length === 1) {
                videoListContainer.style.display = 'block';
                autoVideoSelectContainer.style.display = 'block';
            }

            // 隐藏无视频提示
            noVideoMessage.style.display = 'none';
        }

        function updateUploadedVideosList() {
            uploadedVideosList.innerHTML = '';

            if (uploadedVideos.length === 0) {
                uploadedVideosList.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-video-slash"></i>
                        <p class="mt-2">暂无视频</p>
                    </div>
                `;
                return;
            }

            uploadedVideos.forEach(video => {
                const videoItem = document.createElement('div');
                videoItem.className = `video-list-item list-group-item list-group-item-action ${video.id === currentVideoId ? 'active' : ''}`;
                videoItem.dataset.videoId = video.id;

                videoItem.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-video text-primary me-2"></i>
                        </div>
                        <div class="flex-grow-1 ms-2">
                            <div class="fw-bold text-truncate" style="max-width: 200px;">${video.filename}</div>
                            <small class="text-muted">
                                ${formatFileSize(video.size)} · ${formatDuration(video.duration)}
                            </small>
                        </div>
                        <div class="flex-shrink-0">
                            <button class="btn btn-sm btn-outline-danger delete-video-btn" data-video-id="${video.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;

                // 点击选择视频
                videoItem.addEventListener('click', function (e) {
                    if (!e.target.classList.contains('delete-video-btn')) {
                        selectVideo(video.id);
                    }
                });

                // 删除视频按钮
                const deleteBtn = videoItem.querySelector('.delete-video-btn');
                deleteBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    deleteVideo(video.id);
                });

                uploadedVideosList.appendChild(videoItem);
            });
        }

        function updateVideoSelectOptions() {
            autoVideoSelect.innerHTML = '<option value="">请选择视频</option>';

            uploadedVideos.forEach(video => {
                const option = document.createElement('option');
                option.value = video.id;
                option.textContent = `${video.filename} (${formatDuration(video.duration)})`;
                autoVideoSelect.appendChild(option);
            });

            // 如果当前有选中的视频，设置为选中状态
            if (currentVideoId) {
                autoVideoSelect.value = currentVideoId;
                enableAutoCaptureForm();
            } else {
                disableAutoCaptureForm();
            }
        }

        function selectVideo(videoId) {
            const video = uploadedVideos.find(v => v.id === videoId);
            if (!video) return;

            currentVideoId = videoId;

            // 更新当前视频信息显示
            currentVideoInfo.style.display = 'inline-block';
            currentVideoInfo.textContent = video.filename;

            // 更新视频播放器
            videoSource.src = video.url;
            videoPlayer.load();
            videoPlayerContainer.style.display = 'block';
            currentVideoName.textContent = video.filename;

            // 启用手动截图按钮
            manualCaptureBtn.disabled = false;
            batchCaptureBtn.disabled = false;

            // 更新视频列表选中状态
            updateUploadedVideosList();

            // 更新自动截图视频选择
            autoVideoSelect.value = videoId;
            enableAutoCaptureForm();

            // 设置视频时长
            videoPlayer.addEventListener('loadedmetadata', function () {
                videoDuration.textContent = formatTime(videoPlayer.duration);

                // 设置结束时间默认值
                if (!endTimeInput.value || endTimeInput.value > videoPlayer.duration) {
                    endTimeInput.value = Math.floor(videoPlayer.duration);
                }

                // 更新开始时间的最大值
                startTimeInput.max = Math.floor(videoPlayer.duration) - 1;
            }, { once: true });

            // 更新当前时间显示
            videoPlayer.addEventListener('timeupdate', function () {
                currentTime.textContent = formatTime(videoPlayer.currentTime);
            });

            addActivity(`选择视频：${video.filename}`);
        }

        function deleteVideo(videoId) {
            layer.confirm('确定要删除这个视频吗？删除后相关的截图也会被删除。', {
                icon: 3,
                title: '确认删除'
            }, function (index) {
                fetch(`/api/project/${projectId}/video/${videoId}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 从数组中移除
                            uploadedVideos = uploadedVideos.filter(v => v.id !== videoId);

                            // 更新显示
                            updateUploadedVideosList();
                            updateVideoSelectOptions();
                            videoCount.textContent = `${uploadedVideos.length}个`;

                            // 如果删除的是当前视频
                            if (currentVideoId === videoId) {
                                currentVideoId = null;
                                videoPlayerContainer.style.display = 'none';
                                manualCaptureBtn.disabled = true;
                                batchCaptureBtn.disabled = true;
                                currentVideoInfo.style.display = 'none';
                                disableAutoCaptureForm();

                                // 如果没有其他视频了，显示无视频提示
                                if (uploadedVideos.length === 0) {
                                    videoListContainer.style.display = 'none';
                                    autoVideoSelectContainer.style.display = 'none';
                                    noVideoMessage.style.display = 'block';
                                }
                            }

                            addActivity(`删除视频成功`);
                            layer.msg('删除成功');
                        } else {
                            layer.msg('删除失败：' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        layer.msg('删除视频时发生错误');
                    });

                layer.close(index);
            });
        }

        function enableAutoCaptureForm() {
            intervalInput.disabled = false;
            maxCountInput.disabled = false;
            startTimeInput.disabled = false;
            endTimeInput.disabled = false;
            startAutoCaptureBtn.disabled = false;
        }

        function disableAutoCaptureForm() {
            intervalInput.disabled = true;
            maxCountInput.disabled = true;
            startTimeInput.disabled = true;
            endTimeInput.disabled = true;
            startAutoCaptureBtn.disabled = true;
        }

        // 3. 视频播放控制
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDuration(seconds) {
            if (seconds < 60) {
                return `${seconds}秒`;
            } else if (seconds < 3600) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}分${secs}秒`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                return `${hours}小时${mins}分`;
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            else if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            else return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        // 跳转到指定时间
        jumpBtn.addEventListener('click', function () {
            const minutes = parseInt(jumpMinute.value) || 0;
            const seconds = parseInt(jumpSecond.value) || 0;
            const totalSeconds = minutes * 60 + seconds;

            if (videoPlayer.duration && totalSeconds <= videoPlayer.duration) {
                videoPlayer.currentTime = totalSeconds;
            } else {
                layer.msg('时间超出视频范围');
            }
        });

        // 4. 手动截图功能
        manualCaptureBtn.addEventListener('click', function () {
            if (!currentVideoId) {
                layer.msg('请先选择视频！');
                return;
            }

            const video = uploadedVideos.find(v => v.id === currentVideoId);
            if (!video) return;

            const captureData = {
                video_id: currentVideoId,
                current_time: videoPlayer.currentTime,
                project_id: projectId
            };

            manualCaptureBtn.disabled = true;
            manualCaptureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 截图中...';

            fetch(`/api/project/${projectId}/video/manual_capture`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(captureData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        layer.msg('截图成功！');
                        addActivity('手动截图成功');
                        updateManualStats();
                        showPreview(data.image_url, videoPlayer.currentTime);
                    } else {
                        layer.msg('截图失败: ' + data.message);
                    }
                    manualCaptureBtn.disabled = false;
                    manualCaptureBtn.innerHTML = '<i class="fas fa-camera"></i> 手动截图';
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('截图时发生错误');
                    manualCaptureBtn.disabled = false;
                    manualCaptureBtn.innerHTML = '<i class="fas fa-camera"></i> 手动截图';
                });
        });

        // 批量截图
        batchCaptureBtn.addEventListener('click', function () {
            if (!currentVideoId) {
                layer.msg('请先选择视频！');
                return;
            }

            const count = parseInt(captureCountInput.value) || 1;
            if (count < 1 || count > 10) {
                layer.msg('请输入1-10之间的数字！');
                return;
            }

            batchCaptureBtn.disabled = true;
            batchCaptureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 批量截图中...';

            // 批量截图
            const batchData = {
                video_id: currentVideoId,
                current_time: videoPlayer.currentTime,
                count: count,
                project_id: projectId
            };

            fetch(`/api/project/${projectId}/video/batch_capture`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(batchData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        layer.msg(`批量截图完成，共截图${count}张`);
                        addActivity(`批量截图${count}张完成`);
                        updateManualStats();

                        // 显示所有截图的预览
                        data.images.forEach((img, index) => {
                            setTimeout(() => {
                                showPreview(img.url, videoPlayer.currentTime + (index * 2));
                            }, index * 100);
                        });
                    } else {
                        layer.msg('批量截图失败: ' + data.message);
                    }
                    batchCaptureBtn.disabled = false;
                    batchCaptureBtn.innerHTML = '<i class="fas fa-camera-retro"></i> 批量截图';
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('批量截图时发生错误');
                    batchCaptureBtn.disabled = false;
                    batchCaptureBtn.innerHTML = '<i class="fas fa-camera-retro"></i> 批量截图';
                });
        });

        // 5. 截图预览管理
        function showPreview(imageUrl, timestamp) {
            capturePreview.style.display = 'block';

            const previewItem = document.createElement('div');
            previewItem.className = 'col-4 col-md-3 mb-3';
            previewItem.innerHTML = `
                <div class="card h-100">
                    <a href="${imageUrl}" target="_blank" class="text-decoration-none">
                        <img src="${imageUrl}" class="preview-image" alt="截图预览">
                    </a>
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">${formatTime(timestamp)}</small>
                            <button class="btn btn-sm btn-outline-danger delete-preview-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // 限制只显示12张预览
            if (previewContainer.children.length >= 12) {
                previewContainer.removeChild(previewContainer.lastChild);
            }

            previewContainer.insertBefore(previewItem, previewContainer.firstChild);

            // 添加删除按钮事件
            const deleteBtn = previewItem.querySelector('.delete-preview-btn');
            deleteBtn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                previewContainer.removeChild(previewItem);

                // 如果没有预览了，隐藏预览区域
                if (previewContainer.children.length === 0) {
                    capturePreview.style.display = 'none';
                }
            });
        }

        clearPreviewBtn.addEventListener('click', function () {
            previewContainer.innerHTML = '';
            capturePreview.style.display = 'none';
        });

        // 6. 自动截图功能
        startAutoCaptureBtn.addEventListener('click', function (e) {
            e.preventDefault();

            if (!currentVideoId) {
                layer.msg('请先选择视频！');
                return;
            }

            const video = uploadedVideos.find(v => v.id === currentVideoId);
            if (!video) return;

            const autoCaptureData = {
                video_id: currentVideoId,
                interval: parseInt(intervalInput.value) || 5,
                max_count: parseInt(maxCountInput.value) || 10,
                start_time: parseInt(startTimeInput.value) || 0,
                project_id: projectId
            };

            if (endTimeInput.value) {
                autoCaptureData.end_time = parseInt(endTimeInput.value);
            }

            startAutoCaptureBtn.disabled = true;
            startAutoCaptureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 启动中...';

            fetch(`/api/project/${projectId}/video/start_auto_capture`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(autoCaptureData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        stopAutoCaptureBtn.disabled = false;
                        updateAutoCaptureStatus();
                        addActivity('开始自动截图');
                        layer.msg('自动截图已启动');
                    } else {
                        layer.msg('启动失败: ' + data.message);
                        startAutoCaptureBtn.disabled = false;
                        startAutoCaptureBtn.innerHTML = '<i class="fas fa-play"></i> 开始自动截图';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('启动截图时发生错误');
                    startAutoCaptureBtn.disabled = false;
                    startAutoCaptureBtn.innerHTML = '<i class="fas fa-play"></i> 开始自动截图';
                });
        });

        stopAutoCaptureBtn.addEventListener('click', function () {
            stopAutoCaptureBtn.disabled = true;
            stopAutoCaptureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 停止中...';

            fetch(`/api/project/${projectId}/video/stop_auto_capture`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        startAutoCaptureBtn.disabled = false;
                        stopAutoCaptureBtn.disabled = true;
                        stopAutoCaptureBtn.innerHTML = '<i class="fas fa-stop"></i> 停止自动截图';
                        updateAutoCaptureStatus();
                        addActivity('停止自动截图');
                        layer.msg('自动截图已停止');
                    } else {
                        layer.msg('停止失败: ' + data.message);
                        stopAutoCaptureBtn.disabled = false;
                        stopAutoCaptureBtn.innerHTML = '<i class="fas fa-stop"></i> 停止自动截图';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    layer.msg('停止截图时发生错误');
                    stopAutoCaptureBtn.disabled = false;
                    stopAutoCaptureBtn.innerHTML = '<i class="fas fa-stop"></i> 停止自动截图';
                });
        });

        // 自动截图视频选择
        autoVideoSelect.addEventListener('change', function () {
            if (this.value) {
                selectVideo(this.value);
            }
        });

        // 7. 状态管理和活动记录
        function addActivity(message) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();

            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item mb-2 pb-2 border-bottom';
            activityItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <span class="small">${message}</span>
                    <small class="text-muted">${timeStr}</small>
                </div>
            `;

            // 限制只显示5条记录
            if (recentActivity.children.length >= 5) {
                recentActivity.removeChild(recentActivity.lastChild);
            }

            recentActivity.insertBefore(activityItem, recentActivity.firstChild);

            // 如果之前显示的是"暂无活动记录"，则移除
            const noActivity = recentActivity.querySelector('.text-muted');
            if (noActivity && noActivity.textContent === '暂无活动记录') {
                recentActivity.removeChild(noActivity);
            }
        }

        function updateManualStats() {
            // 这里应该调用API获取统计数据
            fetch(`/api/project/${projectId}/capture/stats`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        todayManualCount.textContent = data.today_count || 0;
                        totalManualCount.textContent = data.total_count || 0;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function updateAutoCaptureStatus() {
            fetch(`/api/project/${projectId}/video/auto_capture_status`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.status) {
                        const captured = data.status.captured_count || 0;
                        const max = data.status.max_count || 1;
                        const progress = max > 0 ? (captured / max) * 100 : 0;

                        if (data.status.running) {
                            autoCaptureStatus.innerHTML = '<span class="status-indicator status-running"></span> 运行中';
                            startAutoCaptureBtn.disabled = true;
                            startAutoCaptureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 运行中...';
                            stopAutoCaptureBtn.disabled = false;
                        } else {
                            autoCaptureStatus.innerHTML = '<span class="status-indicator status-stopped"></span> 已停止';
                            startAutoCaptureBtn.disabled = false;
                            startAutoCaptureBtn.innerHTML = '<i class="fas fa-play"></i> 开始自动截图';
                            stopAutoCaptureBtn.disabled = true;
                        }

                        autoCapturedCount.textContent = captured;
                        autoMaxCount.textContent = max;
                        autoCaptureProgress.style.width = `${progress}%`;
                    } else {
                        autoCaptureStatus.innerHTML = '<span class="status-indicator status-stopped"></span> 未运行';
                        startAutoCaptureBtn.disabled = false;
                        startAutoCaptureBtn.innerHTML = '<i class="fas fa-play"></i> 开始自动截图';
                        stopAutoCaptureBtn.disabled = true;
                        autoCapturedCount.textContent = '0';
                        autoMaxCount.textContent = '0';
                        autoCaptureProgress.style.width = '0%';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // 刷新所有状态
        refreshAllStatusBtn.addEventListener('click', function () {
            updateAutoCaptureStatus();
            updateManualStats();
            addActivity('手动刷新状态');
            layer.msg('状态已刷新');
        });

        // 8. 初始化
        function init() {
            // 加载已上传的视频
            fetch(`/api/project/${projectId}/videos`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.videos) {
                        data.videos.forEach(video => {
                            addUploadedVideo(video);
                        });

                        // 如果有视频，选中第一个
                        if (uploadedVideos.length > 0) {
                            selectVideo(uploadedVideos[0].id);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });

            // 初始状态更新
            updateAutoCaptureStatus();
            updateManualStats();
        }

        // 定期更新状态
        setInterval(function () {
            updateAutoCaptureStatus();
        }, 5000);

        // 页面加载完成后初始化
        init();
    });
</script>
{% endblock %}