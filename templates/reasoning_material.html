{% extends "base.html" %}

{% block title %}æ¨ç†ç´ æç®¡ç† - {{ project.name }} - AIæ¨¡å‹è®­ç»ƒå¹³å°{% endblock %}

{% block extra_css %}
<style>
    /* å¤ç”¨ç°æœ‰å›¾ç‰‡ç®¡ç†çš„é€šç”¨æ ·å¼ï¼Œæ–°å¢å°‘é‡ä¸“å±æ ·å¼ */
    .image-card {
        transition: transform 0.2s;
    }

    .image-card:hover {
        transform: scale(1.02);
    }

    .drop-zone {
        border: 2px dashed #007bff;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 2rem;
        text-align: center;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .drop-zone.dragover {
        background-color: #e9ecef;
        border-color: #0056b3;
    }

    .file-info {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .pagination {
        display: flex;
        justify-content: center;
        padding: 20px 0;
    }

    .pagination .page-item {
        margin: 0 2px;
    }

    .pagination .page-link {
        color: #007bff;
        padding: 0.5rem 0.75rem;
        text-decoration: none;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }

    .pagination .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }

    .pagination .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        background-color: #fff;
        border-color: #dee2e6;
    }

    .image-checkbox {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
    }

    .image-card.selected {
        border: 2px solid #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);
    }

    .action-buttons {
        margin-bottom: 1rem;
    }

    .action-buttons .btn {
        margin-right: 0.5rem;
    }

    .rtsp-long-tip {
        font-size: 0.875rem;
        color: #fd7e14;
        margin-top: 0.5rem;
    }

    /* Iframeå®¹å™¨æ ·å¼å¤ç”¨ä¸ä¼˜åŒ– */
    #iframeContainer {
        width: 100%;
        height: 600px;
        margin-top: 10px;
        border: 1px solid #eee;
        border-radius: 4px;
    }

    /* ========== æ ¸å¿ƒï¼šå·¦å³åˆ†æ é…ç½®å¼¹çª—æ ·å¼ ========== */
    .material-config-modal .modal-content {
        border: none;
        border-radius: 0.75rem;
        box-shadow: 0 0.5rem 2rem rgba(0, 0, 0, 0.15);
        max-width: 1200px;
        margin: 2rem auto;
        height: 80vh;
        overflow: hidden;
    }

    .material-config-modal .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 1.25rem 1.5rem;
    }

    .material-config-modal .modal-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #212529;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .material-config-modal .modal-body {
        padding: 0;
        height: calc(80vh - 136px);
        display: flex;
    }

    .material-config-modal .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e9ecef;
        background-color: #f8f9fa;
    }

    /* å·¦ä¾§ï¼šå›¾ç‰‡é¢„è§ˆä¸æ¡†é€‰åŒºåŸŸ */
    .image-select-area {
        width: 65%;
        height: 100%;
        padding: 1rem;
        border-right: 1px solid #e9ecef;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #fafbfc;
    }

    .image-preview-container {
        width: 100%;
        height: 90%;
        border: 2px dashed #dee2e6;
        border-radius: 0.5rem;
        overflow: hidden;
        position: relative;
        background-color: #fff;
        cursor: crosshair;
    }

    .image-preview {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: none;
    }

    .image-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #6c757d;
    }

    /* æ¡†é€‰åŒºåŸŸæ ·å¼ */
    .selection-box {
        position: absolute;
        border: 2px solid #007bff;
        background-color: rgba(0, 123, 255, 0.1);
        pointer-events: none;
        display: none;
    }

    /* å³ä¾§ï¼šåˆ†ç±»é…ç½®åŒºåŸŸ */
    .category-config-area {
        width: 35%;
        height: 100%;
        padding: 1.5rem;
        overflow-y: auto;
        background-color: #fff;
    }

    .category-title {
        font-size: 1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
    }

    .material-info-card {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    .material-info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .material-info-item:last-child {
        margin-bottom: 0;
    }

    .info-label {
        color: #6c757d;
        font-weight: 500;
    }

    .info-value {
        color: #212529;
        word-break: break-all;
        text-align: right;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 100%;" ms-controller="main_bs_controller">
    <div class="row">
        {% set current_nav_key = 'material'%}
        {% include "project_nav.html"%}
        <div class="col-10">
            <!-- æ ¸å¿ƒï¼šæ¨ç†ç´ æTabåˆ‡æ¢ï¼ˆå›¾ç‰‡/è§†é¢‘/RTSPï¼‰ï¼Œå»¶ç»­IframeåŠ è½½æ¨¡å¼ -->
            <div class="row">
                <ul class="nav nav-tabs" id="inferenceTabContainer">
                    <li class="nav-item">
                        <!-- å›¾ç‰‡æ¨ç†ï¼šæ”¯æŒä¸Šä¼ +æœåŠ¡å™¨è§£æ -->
                        <a class="nav-link active" id="infer-image-tab" aria-current="page" onclick="inferenceTab(this)"
                            data-iframe-url="{{ url_for('main.infer_image_material', project_id=project.id) if project else '' }}">
                            <i class="fas fa-file-image"></i> å›¾ç‰‡æ¨ç†ç´ æ
                        </a>
                    </li>
                    <li class="nav-item">
                        <!-- è§†é¢‘æ¨ç†ï¼šæ”¯æŒä¸Šä¼ +æœåŠ¡å™¨è§£æ -->
                        <a class="nav-link" id="infer-video-tab" onclick="inferenceTab(this)"
                            data-iframe-url="{{ url_for('main.infer_video_material', project_id=project.id) if project else '' }}">
                            <i class="fas fa-file-video"></i> è§†é¢‘æ¨ç†ç´ æ
                        </a>
                    </li>
                    <li class="nav-item">
                        <!-- RTSPæ¨ç†ï¼šæ”¯æŒæ·»åŠ åœ°å€ï¼Œé•¿æœŸæ¨ç†æç¤º -->
                        <a class="nav-link" id="infer-rtsp-tab" onclick="inferenceTab(this)"
                            data-iframe-url="{{ url_for('main.infer_rtsp_material', project_id=project.id) if project else '' }}">
                            <i class="fas fa-stream"></i> RTSPæ¨ç†ç´ æ
                        </a>
                    </li>
                </ul>

                <!-- Iframeå®¹å™¨ï¼šæ‰¿è½½ä¸‰ç§æ¨ç†ç´ æçš„å…·ä½“é¡µé¢ï¼Œä¸å›¾ç‰‡ç®¡ç†é¡µé¢æ ·å¼ä¸€è‡´ -->
                <div id="iframeContainer" 
                        ms-include-src="PageCodeRdm" data-include-rendered='Temprender'
                    style="width: 100%;
    padding-top: 10px;
    margin-top: -2px;
    border: 1px solid #eee;
    border-radius: 0px;
    border-top: 0px;">
                </div>
            </div>
        </div>
    </div>

    <div class="" style="display: none;" id="materialConfigModal" tabindex="-1"
        aria-labelledby="materialConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body" id="materialConfigContainer">
                    <iframe id="materialConfigFrame" src="material_config.html"
                        style="width: 100%; height: 500px; border: none;"></iframe>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveMaterialConfigBtn"
                        onclick="saveMaterialConfig()">ä¿å­˜é…ç½®</button>
                </div>
            </div>
        </div>
    </div>



</div>
<!-- ç»“æœå¼¹çª—ï¼šåŒ…å«åŠ è½½æ¨ç†ç»“æœçš„iframe -->
<div class="" style="display: none;" id="resultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-body" style="height: 70vh; overflow: hidden;">
                <!-- å¼¹çª—iframeï¼šåŠ è½½ä½ çš„resultæ¥å£æ¨¡æ¿é¡µé¢ -->
                <iframe id="resultIframe" width="100%" height="100%" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</div>

<!--æœåŠ¡å™¨è§£æå¼¹æ¡†-->
<div class="" style="display: none;" id="serverPathModal" tabindex="-1">
    <div class="modal-dialog modal-lg" style="padding:10px;">
        <div class="modal-content">
            <form id="serverPathForm">
                <input type="text" class="form-control" hidden name="type">

                <div class="modal-header">
                    <h5 class="modal-title"></h5>
                </div>

                <div class="modal-body">

                    <div class="mb-3">
                        <label class="form-label">æœåŠ¡å™¨ç›®å½•è·¯å¾„ï¼š</label>
                        <span>
                            è§£æçš„ä¸€çº§ç›®å½•ä¸ºç´ æçš„åˆ†ç±»
                        </span>
                        <input type="text" class="form-control" name="path" placeholder="/data/images" required>
                    </div>

                    <!-- è§£æç»“æœæ¸²æŸ“å®¹å™¨ -->
                    <ul class="list-group" id="serverFileList"></ul>

                </div>

                <div class="modal-footer">
                    <button type="button" onclick="analysisServerFile()" class="btn btn-primary" style="margin-left:5px;">è§£æ</button>
                    <button type="button" id="saveSelectedBtn" style="margin-left:5px;" onclick="saveServerFiles()"
                        class="btn btn-success">ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" style="margin-left:5px;" onclick="layer.closeAll()">å…³é—­</button>
                </div>

            </form>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/avalon/avalon1.4.js"></script>
<script>

    var model = avalon.define({
		$id: "main_bs_controller",
        PageCode: "/static/js/avalon/Loading", //éœ€è¦åŠ è½½çš„æ¨¡æ¿
		PageCodeRdm: "/static/js/avalon/Loading.html", //éœ€è¦åŠ è½½çš„æ¨¡æ¿
		rdm: Math.random(), //éšæœºæ•°
		Temprender: function() {
			
		} //ç»„ä»¶åŠ è½½å®Œæˆäº‹ä»¶
        });
	avalon.ready(function() {
        const infertabid=  localStorage.getItem("infertabid");
		// è§¦å‘é»˜è®¤Tabçš„åˆ‡æ¢é€»è¾‘
        const defaultTab = document.getElementById(infertabid||"infer-image-tab");
        if (defaultTab) {
            inferenceTab(defaultTab);
        }
	});

    // å…¨å±€å˜é‡ï¼šè®°å½•å½“å‰æ¨ç†çŠ¶æ€ã€æ¡†é€‰ç›¸å…³å‚æ•°ã€å½“å‰ç´ æä¿¡æ¯
    let isInferring = false;
    let startX = 0, startY = 0, isSelecting = false;
    let currentMaterial = null;
    const projectId = '{{project.id}}'
    const selectionBox = document.getElementById('selectionBox');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');

    


    function saveServerFiles() {
        const selected = [];
        document.querySelectorAll('#serverFileList input[name="selected"]:checked')
            .forEach(cb => selected.push(cb.value));

        if (selected.length === 0) {
            layer.msg('è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„');
            return;
        }

        // æäº¤åˆ°åç«¯ä¿å­˜
        const formData = new FormData();
        selected.forEach(f => formData.append('files', f));

        fetch('{{ url_for("main.save_server_files",project_id= project.id)}}', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(res => {
                if (res.success) {
                    layer.msg('ä¿å­˜æˆåŠŸï¼');
                    // å¯é€‰æ‹©å…³é—­ Modal æˆ–åˆ·æ–°åˆ—è¡¨
                    layer.closeAll();
                } else {
                    layer.msg('ä¿å­˜å¤±è´¥ï¼');
                }
            })
            .catch(err => {
                console.error('ä¿å­˜å¤±è´¥ï¼š', err);
                layer.msg('ä¿å­˜å¤±è´¥ï¼');
            });
    };

    // è§£ææœåŠ¡å™¨æ–‡ä»¶
    function analysisServerFile() {
        const typeInput = document.querySelector("#serverPathForm input[name='type']");
        const form = document.getElementById('serverPathForm');
        const formData = new FormData(form);
        formData.append('type', typeInput.value)

        fetch('{{ url_for("main.parse_server_dir") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(response => {
                if (!response.success) {
                    layer.msg('è§£æå¤±è´¥ï¼');
                    return;
                }

                const items = response.data.items || [];
                const ul = document.getElementById('serverFileList');
                ul.innerHTML = ''; // å…ˆæ¸…ç©ºåˆ—è¡¨

                if (items.length === 0) {
                    ul.innerHTML = '<li class="list-group-item text-muted">ç›®å½•ä¸ºç©º</li>';
                    return;
                }

                items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'form-check-input me-2';
                    checkbox.value = item.path;
                    checkbox.name = 'selected';

                    li.appendChild(checkbox);

                    // æ ¹æ®ç±»å‹æ˜¾ç¤ºå›¾æ ‡
                    const icon = document.createElement('span');
                    icon.textContent = item.is_dir ? 'ğŸ“ ' : 'ğŸ–¼ï¸ ';
                    li.appendChild(icon);

                    const text = document.createTextNode(item.name);
                    li.appendChild(text);

                    ul.appendChild(li);
                });
            })
            .catch(error => {
                console.log('è§£æå¤±è´¥ï¼š', error)
                layer.msg('è§£æå¤±è´¥ï¼')
            })
            .finally(() => {
            })
    }

    /**
     * æ ¸å¿ƒï¼šæ‰“å¼€ç´ æé…ç½®å¼¹çª—ï¼ˆæ›¿ä»£åŸæŠ½å±‰ï¼Œä¾›Iframeå†…éƒ¨é¡µé¢è°ƒç”¨ï¼Œæš´éœ²å…¨å±€æ–¹æ³•ï¼‰
     * @param {Object} material - ç´ æå¯¹è±¡ï¼ŒåŒ…å«idã€pathã€filenameå±æ€§
     */
    function openConfigDrawer(material) {
        if (!material || !material.id || !material.path || !material.filename) {
            layer.msg('æ— æ•ˆçš„ç´ æä¿¡æ¯ï¼Œæ— æ³•æ‰“å¼€é…ç½®å¼¹çª—');
            return;
        }

        // ä¿å­˜å½“å‰ç´ æä¿¡æ¯
        currentMaterial = material;
        console.log('å½“å‰å¾…é…ç½®ç´ æï¼š', currentMaterial);


        const staticBaseUrl = `${window.location.origin}/static/`;
        const imageSrc = staticBaseUrl + `${material.path}`; // æˆ–ä½¿ç”¨åç«¯æä¾›çš„ç´ æè®¿é—®æ¥å£

        // è·å–iframeå…ƒç´ 
        layer.open({
                title:"ç´ æé…ç½®ä¸åŒºåŸŸæ¡†é€‰",
                type: 2, 
                area: ['90%', '90%'],
                content: `/api/material/${projectId}/config/${material.id}` //è¿™é‡Œcontentæ˜¯ä¸€ä¸ªæ™®é€šçš„String
        });
    }

    /**
     * æ¨ç†ç´ æTabåˆ‡æ¢
     */
    function inferenceTab(tabLink) {
        // é˜»æ­¢aæ ‡ç­¾é»˜è®¤è·³è½¬è¡Œä¸º
        event.preventDefault();

        // ç§»é™¤æ‰€æœ‰Tabçš„activeé«˜äº®çŠ¶æ€
        const allTabLinks = document.querySelectorAll('#inferenceTabContainer .nav-link');
        allTabLinks.forEach(link => {
            link.classList.remove('active');
            link.removeAttribute('aria-current');
        });

        // ç»™å½“å‰ç‚¹å‡»çš„Tabæ·»åŠ activeé«˜äº®çŠ¶æ€
        tabLink.classList.add('active');
        tabLink.setAttribute('aria-current', 'page');
        localStorage.setItem("infertabid",tabLink.getAttribute("id"));
        const iframeUrl = tabLink.dataset.iframeUrl;
        const iframeContainer = document.getElementById('iframeContainer');
        model.PageCodeRdm = iframeUrl;

        // if (!iframeUrl || iframeUrl === '#') {
        //     iframeContainer.innerHTML = '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999;">æš‚æ— å¯ç”¨å†…å®¹</div>';
        //     return;
        // }

        // let iframe = iframeContainer.querySelector('iframe');
        // if (iframe) {
        //     iframe.src = iframeUrl;
        // } else {
        //     // åŠ¨æ€åˆ›å»ºæ–°iframeå¹¶æ’å…¥å®¹å™¨ï¼Œä¿æŒä¸å›¾ç‰‡ç®¡ç†é¡µé¢ä¸€è‡´çš„é…ç½®
        //     iframe = document.createElement('iframe');
        //     iframe.id = 'materialIframe'
        //     iframe.src = iframeUrl;
        //     iframe.width = '100%';
        //     iframe.height = '100%';
        //     iframe.frameBorder = '0';
        //     iframe.allowFullscreen = true;

        //     iframe.onload = function () {
        //         console.log(`[${tabLink.innerText}] æ¨ç†ç´ æé¡µé¢åŠ è½½å®Œæˆ`);
        //     };
        //     iframe.onerror = function () {
        //         iframeContainer.innerHTML = '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #f56c6c;">å†…å®¹åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
        //     };

        //     iframeContainer.innerHTML = '';
        //     iframeContainer.appendChild(iframe);
        // }
    }

    /**
     * åˆ é™¤æ¨ç†ç´ æ
     */
    function deleteMaterial(ids) {
        layer.confirm('ä½ ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ', {
            icon: 3,
            title: 'ç¡®è®¤æäº¤',
            offset: 'center'
        }, function (index) {
            layer.close(index);
            fetch('{{ url_for("main.delete_material", project_id=project.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ids: ids })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`è¯·æ±‚å¤±è´¥ï¼ˆçŠ¶æ€ç ï¼š${response.status}ï¼‰`);
                    }
                    return response.json();
                })
                .then(res => {
                    if (!res.success) {
                        layer.msg(res.message, {
                            icon: 2,
                            time: 3000,
                            offset: 'center'
                        });
                        return;
                    }
                    layer.msg('åˆ é™¤æˆåŠŸ', {
                        icon: 1,
                        time: 2000,
                        offset: 'center'
                    });
                    setTimeout(() => {
                        sendMaterialMessage('refrensh') // ä¿®æ­£æ‹¼å†™é”™è¯¯ï¼šrefrensh â†’ refresh
                    }, 2000)
                })
                .catch(error => {
                    const errorMsg = error.message || 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•';
                    layer.alert(errorMsg, {
                        title: 'åˆ é™¤å¤±è´¥',
                        icon: 2,
                        offset: 'center'
                    });
                    console.error('åˆ é™¤å¤±è´¥ï¼š', error);
                });
        });
    }

    /*
    å‘é€æ¶ˆæ¯ç»™ç´ æiframe
    */
    function sendMaterialMessage(type, data = null) {
        const materialIframe = document.getElementById('materialIframe');
        if (materialIframe && materialIframe.contentWindow) {
            materialIframe.contentWindow.postMessage(
                { type: type, data: data },
                window.location.origin
            );
        }
    }
    // ä¿å­˜ç´ æé…ç½®
    function saveMaterialConfig() {
        const materialConfigFrame = document.getElementById('materialConfigFrame');
        if (materialConfigFrame && materialConfigFrame.contentWindow) {
            materialConfigFrame.contentWindow.postMessage(
                { type: 'save' },
                window.location.origin
            );
        }
    }

    function closeMaterialConfigModal() {
        layer.closeAll();
    }

    // ç›‘å¬Iframeå‘é€çš„æ¶ˆæ¯
    // window.addEventListener('message', function (event) {
    //     if (!window.ALLOWED_ORIGINS.includes(event.origin)) return;

    //     if (event.data.type === 'deleteMaterial') {
    //         const ids = event.data.data;
    //         deleteMaterial(ids);
    //     }
    //     if (event.data.type === 'close') {
    //         closeMaterialConfigModal();
    //     }
    //     if (event.data.type === 'openResultModal') {
    //         const { projectId, materialId } = event.data;
    //         // 1. è®¾ç½®å¼¹çª—iframeçš„srcä¸ºä½ çš„ç»“æœæ¥å£
    //         const resultIframe = document.getElementById('resultIframe');
    //         resultIframe.src = `/api/inference/${projectId}/result/${materialId}`;

    //         // 2. æ‰“å¼€å¼¹çª—
    //         const modal = new bootstrap.Modal(document.getElementById('resultModal'));
    //         modal.show();
    //     }
    //     if (event.data.type === 'openServerFileModal') {
    //         const { projectId, fileType } = event.data;
    //         console.log(projectId, fileType)
    //         // æ‰“å¼€å¼¹çª—
    //         const modal = new bootstrap.Modal(document.getElementById('serverPathModal'));
    //         modal.show();

    //         const typeInput = document.querySelector("#serverPathForm input[name='type']");
    //         typeInput.value = fileType;  // ç»™å®ƒèµ‹å€¼

    //     }
    // });
</script>
{% endblock %}